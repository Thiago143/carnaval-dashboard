<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d0d1a">
<title>4o BPM - Carnaval 2026 - Painel Tatico</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#127919;</text></svg>">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:#0d0d1a;color:#e0e0e0;overflow:hidden;height:100vh}
:root{--red:#dc3545;--yellow:#ffc107;--green:#28a745;--gray:#6c757d;--blue:#448AFF;--purple:#9b59b6;--dark:#0d0d1a;--panel:#141428;--border:#1e3a5f;--accent:#e94560;--text:#e0e0e0;--muted:#888;--sidebar-w:320px}
#sidebar{position:fixed;left:0;top:0;width:var(--sidebar-w);height:100vh;background:linear-gradient(180deg,#141428 0%,#0f1f35 100%);z-index:1000;overflow-y:auto;overflow-x:hidden;border-right:2px solid var(--border);display:flex;flex-direction:column;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
#sidebar::-webkit-scrollbar{width:5px}
#sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
#map{position:fixed;left:var(--sidebar-w);top:0;right:0;bottom:0}
.header{background:linear-gradient(135deg,#0f3460,#1a1a4e);padding:14px 16px;text-align:center;border-bottom:2px solid var(--accent)}
.header h1{font-size:15px;color:#fff;letter-spacing:1.5px;font-weight:800}
.header h2{font-size:11px;color:var(--accent);margin-top:3px;font-weight:500;letter-spacing:0.5px}
.turno-bar{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;background:rgba(15,52,96,0.4);border-bottom:1px solid var(--border)}
.turno-bar span{font-size:12px;color:var(--muted)}
.turno-bar .val{color:var(--accent);font-weight:700}
.turno-bar .timer{color:#ffc107;font-weight:600;font-size:11px}
.sitrep{padding:10px 16px;background:rgba(40,167,69,0.08);border-bottom:1px solid var(--border);font-size:11px;line-height:1.5}
.sitrep .sitrep-title{color:var(--accent);font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px}
.sitrep .sitrep-text{color:#ccc}
.sitrep .critical{color:var(--red);font-weight:600}
.section{padding:10px 16px}
.section-title{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:4px;font-weight:600}
.stat-row{display:flex;align-items:center;margin-bottom:5px;font-size:12px}
.stat-label{width:30px;font-weight:700;text-align:center;border-radius:4px;padding:3px 0;margin-right:8px;font-size:10px}
.stat-bar-bg{flex:1;height:20px;background:rgba(255,255,255,0.04);border-radius:10px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,0.06);display:flex;align-items:center}
.stat-bar{height:100%;border-radius:10px;transition:width .6s cubic-bezier(.4,0,.2,1)}
.stat-text{position:absolute;right:8px;font-size:10px;color:#fff;font-weight:700;text-shadow:0 1px 3px rgba(0,0,0,.8)}
.big-pct-wrap{text-align:center;padding:8px 16px}
.big-pct{font-size:48px;font-weight:900;transition:color .5s}
.big-pct.low{color:var(--red);text-shadow:0 0 30px rgba(220,53,69,.25)}
.big-pct.mid{color:var(--yellow);text-shadow:0 0 30px rgba(255,193,7,.2)}
.big-pct.high{color:var(--green);text-shadow:0 0 30px rgba(40,167,69,.25)}
.extra-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;padding:0 16px 8px}
.extra-box{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:8px 4px;text-align:center;transition:border-color .3s}
.extra-box .num{font-size:20px;font-weight:800}
.extra-box .lbl{font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px}
.extra-box.done{border-color:var(--green)}
.btn{display:block;width:100%;padding:9px;margin-bottom:5px;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:0.5px;-webkit-tap-highlight-color:transparent}
.btn:hover{transform:translateY(-1px);filter:brightness(1.1)}
.btn:active{transform:translateY(0);filter:brightness(0.95)}
.btn-red{background:linear-gradient(135deg,#dc3545,#c82333);color:#fff}
.btn-yellow{background:linear-gradient(135deg,#ffc107,#e0a800);color:#1a1a2e}
.btn-green{background:linear-gradient(135deg,#28a745,#218838);color:#fff}
.btn-blue{background:linear-gradient(135deg,#448AFF,#2979FF);color:#fff}
.btn-gray{background:linear-gradient(135deg,#6c757d,#5a6268);color:#fff}
.btn-purple{background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-small{display:inline-block;width:auto;padding:5px 12px;font-size:10px;margin:2px}
.btn-group{display:flex;gap:4px;margin-bottom:5px}
.btn-group .btn{margin-bottom:0;flex:1}
.log-list{max-height:120px;overflow-y:auto;scrollbar-width:thin}
.log-entry{font-size:10px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:6px}
.log-entry .log-time{color:var(--accent);font-weight:600;min-width:40px}
.log-entry .log-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.log-entry .log-msg{color:#bbb}
.legend{padding:8px 16px}
.legend-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.legend-item{display:flex;align-items:center;font-size:10px;color:var(--muted);gap:5px}
.footer{padding:8px 16px;background:rgba(0,0,0,.3);border-top:1px solid var(--border);font-size:10px;color:#555;text-align:center;margin-top:auto}
.footer .ts{color:var(--accent)}
.share-section{padding:8px 16px;border-top:1px solid var(--border)}
.share-section textarea{width:100%;height:50px;background:var(--dark);color:var(--text);border:1px solid var(--border);border-radius:6px;font-size:10px;font-family:monospace;padding:6px;resize:none;display:none;margin-top:4px}
.share-url{font-size:10px;color:var(--green);padding:4px 0;word-break:break-all;display:none}
.leaflet-popup-content-wrapper{background:#1a1a2e;color:var(--text);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.5)}
.leaflet-popup-tip{background:#1a1a2e;border:1px solid var(--border)}
.leaflet-popup-content{margin:12px 14px;font-size:12px;line-height:1.5}
.popup-title{font-size:15px;font-weight:800;margin-bottom:2px}
.popup-sub{font-size:11px;color:var(--muted);margin-bottom:2px}
.popup-local{font-size:11px;color:#aaa;margin-bottom:8px}
.popup-status{font-size:12px;margin-bottom:10px}
.popup-status .badge{font-weight:700;padding:3px 10px;border-radius:4px;font-size:11px;display:inline-block}
.popup-hora{font-size:10px;color:var(--muted);margin-left:6px}
.popup-btns{display:flex;gap:4px;flex-wrap:wrap}
.popup-btns .btn{width:auto;padding:6px 12px;font-size:10px;margin:0;min-width:60px}
.monitor-banner{background:var(--red);color:#fff;text-align:center;padding:8px;font-size:13px;font-weight:800;letter-spacing:3px;display:none;animation:pulse 2s infinite}
.monitor-banner.active{display:block}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.map-controls{position:fixed;top:10px;right:10px;z-index:1001;display:flex;gap:6px}
.map-btn{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600}
.map-btn:hover{border-color:var(--accent)}
.map-btn.active{border-color:var(--accent);color:var(--accent)}
@media(max-width:768px){
:root{--sidebar-w:100vw}
#sidebar{width:100%;height:auto;max-height:42vh;position:relative;border-right:none;border-bottom:2px solid var(--border)}
#map{position:relative;left:0;height:58vh;width:100%}
body{overflow-y:auto;height:auto}
.header h1{font-size:13px}
.big-pct{font-size:36px}
.map-controls{top:auto;bottom:10px}
}
</style>
</head>
<body>
<div id="monitor-banner" class="monitor-banner">MODO MONITOR — SOMENTE LEITURA — AUTO-REFRESH 5s</div>
<div id="sidebar">
<div class="header"><h1>4o BPM — CARNAVAL 2026</h1><h2>PAINEL TATICO DE IMPLANTACAO</h2></div>
<div class="turno-bar">
<span>Turno: <span class="val" id="turnoVal">1o (17h-01h)</span></span>
<span>Fase: <span class="val" id="faseVal">IMPLANTACAO</span></span>
<span class="timer" id="timerVal"></span>
</div>
<div class="sitrep" id="sitrepDiv"><div class="sitrep-title">SITREP</div><div class="sitrep-text" id="sitrepText">Aguardando dados...</div></div>
<div class="section">
<div class="section-title">Progresso por Subarea</div>
<div class="stat-row"><div class="stat-label" style="background:#FFD700;color:#000">A1</div><div class="stat-bar-bg"><div class="stat-bar" id="barA1" style="width:0%;background:linear-gradient(90deg,#FFD700,#FFA000)"></div><span class="stat-text" id="txtA1">0/16</span></div></div>
<div class="stat-row"><div class="stat-label" style="background:#C0C0C0;color:#000">A2</div><div class="stat-bar-bg"><div class="stat-bar" id="barA2" style="width:0%;background:linear-gradient(90deg,#C0C0C0,#9E9E9E)"></div><span class="stat-text" id="txtA2">0/8</span></div></div>
<div class="stat-row"><div class="stat-label" style="background:#00E676;color:#000">B1</div><div class="stat-bar-bg"><div class="stat-bar" id="barB1" style="width:0%;background:linear-gradient(90deg,#00E676,#00C853)"></div><span class="stat-text" id="txtB1">0/12</span></div></div>
<div class="stat-row"><div class="stat-label" style="background:#448AFF;color:#fff">B2</div><div class="stat-bar-bg"><div class="stat-bar" id="barB2" style="width:0%;background:linear-gradient(90deg,#448AFF,#2962FF)"></div><span class="stat-text" id="txtB2">0/16</span></div></div>
</div>
<div class="big-pct-wrap"><div class="big-pct low" id="bigPct">0%</div></div>
<div class="extra-stats">
<div class="extra-box" id="boxTorres"><div class="num" id="statTorres">0/6</div><div class="lbl">Torres</div></div>
<div class="extra-box" id="boxPogs"><div class="num" id="statPogs">0/20</div><div class="lbl">POGs</div></div>
<div class="extra-box" id="boxMptr"><div class="num" id="statMptr">0/2</div><div class="lbl">MPTR</div></div>
</div>
<div class="section" id="controlsDiv">
<div class="section-title">Controles Rapidos</div>
<div class="btn-group">
<button class="btn btn-red" onclick="marcarRoteiro('R1','EM_TRANSITO')">R1 Saiu</button>
<button class="btn btn-blue" onclick="marcarRoteiro('R2','EM_TRANSITO')">R2 Saiu</button>
<button class="btn btn-green" onclick="marcarRoteiro('R3','EM_TRANSITO')">R3 Saiu</button>
</div>
<button class="btn btn-yellow" onclick="marcarRoteiro('A_PE','EM_TRANSITO')">Hub 2 (BPChq) — A Pe Saiu</button>
<button class="btn btn-purple" onclick="marcarMPTR()">MPTR OK (APREVs 21 + 46)</button>
<div style="margin-top:8px"><div class="section-title">Implantacao Rapida</div>
<div class="btn-group">
<button class="btn btn-green btn-small" onclick="marcarRoteiroImpl('R1')">R1 Impl</button>
<button class="btn btn-green btn-small" onclick="marcarRoteiroImpl('R2')">R2 Impl</button>
<button class="btn btn-green btn-small" onclick="marcarRoteiroImpl('R3')">R3 Impl</button>
</div>
<button class="btn btn-green btn-small" onclick="marcarRoteiroImpl('A_PE')" style="width:100%">Hub2 Implantado</button>
</div>
<div style="margin-top:8px"><div class="section-title">Fase / Turno</div>
<div class="btn-group">
<button class="btn btn-outline" onclick="alternarFase()">Alternar Fase</button>
<button class="btn btn-outline" onclick="alternarTurno()">Proximo Turno</button>
</div>
<button class="btn btn-red btn-small" onclick="resetTurno()" style="width:100%">Reset Turno (Zerar Tudo)</button>
</div></div>
<div class="share-section" id="shareDiv">
<div class="section-title">Compartilhar com Comando</div>
<button class="btn btn-blue" onclick="compartilharLink()">Copiar Link para Comando</button>
<div class="share-url" id="shareUrl"></div>
<div class="btn-group" style="margin-top:4px">
<button class="btn btn-outline btn-small" onclick="exportarJSON()">Exportar JSON</button>
<button class="btn btn-outline btn-small" onclick="toggleImport()">Importar</button>
</div>
<textarea id="importArea" placeholder="Cole o JSON ou link aqui..."></textarea>
<button class="btn btn-green btn-small" id="btnAplicar" style="display:none;width:100%;margin-top:4px" onclick="importarEstado()">Aplicar</button>
</div>
<div class="section" id="logSection"><div class="section-title">Log Recente</div><div class="log-list" id="logList"><div class="log-entry"><span class="log-msg" style="color:#555">Nenhuma acao registrada</span></div></div></div>
<div class="legend"><div class="section-title">Legenda</div>
<div class="legend-grid">
<div class="legend-item"><svg width="14" height="14"><circle cx="7" cy="7" r="6" fill="#dc3545"/></svg> Pendente</div>
<div class="legend-item"><svg width="14" height="14"><circle cx="7" cy="7" r="6" fill="#ffc107"/></svg> Em Transito</div>
<div class="legend-item"><svg width="14" height="14"><circle cx="7" cy="7" r="6" fill="#28a745"/></svg> Implantado</div>
<div class="legend-item"><svg width="14" height="14"><circle cx="7" cy="7" r="6" fill="#6c757d"/></svg> Desmobilizado</div>
</div>
<div class="legend-grid" style="margin-top:6px">
<div class="legend-item"><svg width="18" height="22" viewBox="0 0 28 36"><path d="M14 34 C14 34 3 21 3 13 A11 11 0 1 1 25 13 C25 21 14 34 14 34Z" fill="#888" stroke="#fff" stroke-width="1.5"/></svg> APREV</div>
<div class="legend-item"><svg width="18" height="18" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9" fill="#888" stroke="#fff" stroke-width="1.5" stroke-dasharray="4 2"/></svg> POG</div>
<div class="legend-item"><svg width="14" height="22" viewBox="0 0 18 30"><line x1="9" y1="1" x2="9" y2="7" stroke="#888" stroke-width="2"/><line x1="5" y1="4" x2="13" y2="4" stroke="#888" stroke-width="1.5"/><rect x="2" y="7" width="14" height="21" rx="2" fill="#888" stroke="#fff" stroke-width="1"/></svg> Torre</div>
<div class="legend-item"><svg width="18" height="18" viewBox="0 0 24 24"><polygon points="12,1 15,9 23,9 17,14 19,22 12,17 5,22 7,14 1,9 9,9" fill="#FFD700" stroke="#333" stroke-width="1"/></svg> Hub</div>
</div>
<div style="margin-top:6px;font-size:9px;color:#555">Borda do pin = subarea: <span style="color:#FFD700">A1</span> | <span style="color:#C0C0C0">A2</span> | <span style="color:#00E676">B1</span> | <span style="color:#448AFF">B2</span></div>
</div>
<div class="footer">Ultima atualizacao: <span class="ts" id="lastUpdate">--</span><br><span style="color:#444">4o BPM — Sambodromo — Carnaval 2026</span></div>
</div>
<div class="map-controls" id="mapControls">
<button class="map-btn active" onclick="setTile('dark')" id="btnDark">Noturno</button>
<button class="map-btn" onclick="setTile('light')" id="btnLight">Diurno</button>
<button class="map-btn" onclick="setTile('sat')" id="btnSat">Satelite</button>
</div>
<div id="map"></div>
<script>
var DADOS=[
{tipo:'APREV',num:'01',sub:'B2',lat:-22.909049,lon:-43.188747,local:'R. Frei Caneca c/ Pca Republica',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'02',sub:'B1',lat:-22.905428,lon:-43.190713,local:'Av. Pres. Vargas c/ Pca Republica',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'03',sub:'B1',lat:-22.905971,lon:-43.192781,local:'Av. Pres. Vargas c/ R. Gal. Caldwell',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'04',sub:'B1',lat:-22.906118,lon:-43.194840,local:'Av. Pres. Vargas c/ R. Santana ZN',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'05',sub:'B1',lat:-22.907256,lon:-43.190262,local:'Pca Republica c/ R. Moncorvo Filho',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'06',sub:'B1',lat:-22.909121,lon:-43.191858,local:'R. Gal. Caldwell c/ R. Moncorvo Filho',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'07',sub:'B1',lat:-22.906929,lon:-43.192519,local:'R. Frederico Silva c/ R. Gal. Caldwell',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'08',sub:'B1',lat:-22.907530,lon:-43.194252,local:'R. Benedito Hipolito c/ R. Santana',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'09',sub:'B2',lat:-22.911417,lon:-43.191381,local:'Av. Mem de Sa c/ R. do Senado',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'10',sub:'B2',lat:-22.910980,lon:-43.192931,local:'Av. Mem de Sa c/ R. Frei Caneca',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'11',sub:'B2',lat:-22.912982,lon:-43.191321,local:'Av. Riachuelo c/ Av. H. Valadares',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'12',sub:'B2',lat:-22.911242,lon:-43.193456,local:'R. Frei Caneca c/ R. Mqs Pombal',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'13',sub:'B1',lat:-22.907660,lon:-43.195389,local:'R. B. Hipolito c/ R. Mqs Pombal',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'14',sub:'B2',lat:-22.911484,lon:-43.195358,local:'R. Salvador Sa c/ Rampa Vd 31 Marco',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'15',sub:'B1',lat:-22.906426,lon:-43.197728,local:'Vd S.Pedro c/ Vd 31 de Marco',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'16',sub:'B2',lat:-22.912524,lon:-43.195293,local:'R. F.Caneca emb. Vd 31 Marco',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'17',sub:'B2',lat:-22.916010,lon:-43.193800,local:'R. F.Caneca c/ R. Eleone Almeida',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'18',sub:'B1',lat:-22.906425,lon:-43.195998,local:'Av. P.Vargas ZN acesso Vd 31 Marco',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'19',sub:'B1',lat:-22.904586,lon:-43.190205,local:'Av. P.Vargas c/ R. B.Ribeiro ZN',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'20',sub:'B2',lat:-22.910171,lon:-43.191522,local:'R. Gal. Caldwell c/ R. Frei Caneca',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'21',sub:'B2',lat:-22.920491,lon:-43.193768,local:'Saida Tunel Sta Barbara',hub:'MPTR',rot:'MPTR'},
{tipo:'APREV',num:'22',sub:'B2',lat:-22.917835,lon:-43.194818,local:'R. Dr. Lagden c/ R. Itapiru',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'23',sub:'B2',lat:-22.914204,lon:-43.196744,local:'R. F.Caneca c/ R. Sr Matosinhos',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'24',sub:'A1',lat:-22.907562,lon:-43.199529,local:'Av. P.Vargas ZN prox Estacio',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'25',sub:'A1',lat:-22.909154,lon:-43.204447,local:'Av. P.Vargas ZN prox pto onibus',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'26',sub:'B2',lat:-22.912086,lon:-43.197484,local:'Tv. 11 Maio c/ Av. Salvador Sa',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'27',sub:'A2',lat:-22.913008,lon:-43.202825,local:'R. Salvador Sa c/ R. F.Caneca',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'28',sub:'A2',lat:-22.914458,lon:-43.198592,local:'R. F.Caneca c/ R. A.Benevolo',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'29',sub:'A1',lat:-22.909417,lon:-43.198472,local:'R. Pres. Barroso c/ R. J.Carmo',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'30',sub:'A1',lat:-22.912530,lon:-43.205169,local:'R. U.Guimaraes c/ R. H.Beltrao',hub:'4BPM',rot:'R1'},
{tipo:'APREV',num:'31',sub:'A1',lat:-22.909974,lon:-43.200564,local:'R. Laura Araujo e/f Metro PcaXI',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'32',sub:'A1',lat:-22.908589,lon:-43.200632,local:'Av. P.Vargas Centro c/ R. C.Neto',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'33',sub:'A1',lat:-22.909782,lon:-43.204332,local:'Av. P.Vargas e/f Correios',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'34',sub:'A1',lat:-22.909838,lon:-43.202243,local:'R. A.Lima c/ R. Af. Cavalcanti',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'35',sub:'A2',lat:-22.913813,lon:-43.200823,local:'R. F.Caneca c/ R. Pirassununga',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'36',sub:'A2',lat:-22.912392,lon:-43.199423,local:'Av. Salvador Sa c/ R. C.Neto',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'37',sub:'A1',lat:-22.912932,lon:-43.209673,local:'R. J.Palhares c/ Av. P.Frontin',hub:'4BPM',rot:'R1'},
{tipo:'APREV',num:'38',sub:'A1',lat:-22.910857,lon:-43.205660,local:'R. Af. Cavalcanti e/f Prefeitura',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'39',sub:'A2',lat:-22.912509,lon:-43.200101,local:'R. Laura Araujo c/ Av. Salvador',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'40',sub:'B2',lat:-22.914215,lon:-43.196095,local:'R. F.Caneca c/ R. Catumbi',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'41',sub:'A2',lat:-22.914551,lon:-43.207573,local:'R. J.Palhares c/ R. J.Paulo Io',hub:'4BPM',rot:'R1'},
{tipo:'APREV',num:'42',sub:'A1',lat:-22.911455,lon:-43.201812,local:'R. C.Vasques c/ R. Sta Maria',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'43',sub:'A1',lat:-22.907386,lon:-43.199240,local:'Av. P.Vargas ZN apoio GM',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'44',sub:'A1',lat:-22.910941,lon:-43.198920,local:'R. S.Martinho c/ R. A.Benevolo',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'45',sub:'A1',lat:-22.910832,lon:-43.198422,local:'R. Pres. Barroso c/ R. S.Martinho',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'46',sub:'A2',lat:-22.935017,lon:-43.209576,local:'Entrada Tunel Reboucas',hub:'MPTR',rot:'MPTR'},
{tipo:'APREV',num:'47',sub:'A2',lat:-22.914233,lon:-43.205022,local:'R. Estacio Sa c/ R. M.Lacerda',hub:'4BPM',rot:'R1'},
{tipo:'APREV',num:'48',sub:'B1',lat:-22.908148,lon:-43.196443,local:'Terreirao Samba — Carro Cmd',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'49',sub:'B2',lat:-22.915623,lon:-43.193655,local:'R. J.Alencar c/ R. E.Almeida',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'50',sub:'B2',lat:-22.917019,lon:-43.195136,local:'R. Catumbi c/ R. Chichorro',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'51',sub:'A1',lat:-22.906899,lon:-43.210238,local:'R. F.Bicalho c/ R. F.Eugenio',hub:'4BPM',rot:'R1'},
{tipo:'APREV',num:'52',sub:'A1',lat:-22.910628,lon:-43.208406,local:'Sob Viaduto dos Pracinhas',hub:'4BPM',rot:'R1'},
{tipo:'POG',num:'01',sub:'B1',lat:-22.909678,lon:-43.194363,local:'Rua Marques de Pombal',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'02',sub:'B1',lat:-22.906926,lon:-43.197484,local:'Av. P.Vargas Vd31 ate R.Santana',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'03',sub:'B1',lat:-22.907990,lon:-43.196120,local:'R. B.Hipolito bilheteria/R.Santana',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'04',sub:'B1',lat:-22.909778,lon:-43.196571,local:'Vd 31 Marco sent tunel StaBarbara',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'05',sub:'B1',lat:-22.908810,lon:-43.193702,local:'R. Santana P.Vargas/F.Caneca',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'06',sub:'B2',lat:-22.913968,lon:-43.195599,local:'R. F.Caneca dispersao P.Matos',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'07',sub:'A1',lat:-22.907306,lon:-43.215524,local:'R. Francisco Eugenio (2 sent)',hub:'4BPM',rot:'R1'},
{tipo:'POG',num:'08',sub:'A1',lat:-22.913343,lon:-43.209794,local:'Av. P.Frontin C4/1 ate Sulamerica',hub:'4BPM',rot:'R3'},
{tipo:'POG',num:'09',sub:'A2',lat:-22.912816,lon:-43.201580,local:'Av. Salvador Sa N.Pinheiro/Laura',hub:'4BPM',rot:'R1'},
{tipo:'POG',num:'10',sub:'A1',lat:-22.910872,lon:-43.203424,local:'R. Julio Carmo P.Azevedo/C.Vasques',hub:'4BPM',rot:'R2'},
{tipo:'POG',num:'11',sub:'A1',lat:-22.912297,lon:-43.204714,local:'R. Ulysses Guimaraes COR-RJ',hub:'4BPM',rot:'R1'},
{tipo:'POG',num:'12',sub:'B1',lat:-22.908260,lon:-43.197011,local:'R. B.Hipolito Vd31/Terreirao',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'13',sub:'A1',lat:-22.910852,lon:-43.206891,local:'Av. P.Vargas escada Cidade Nova',hub:'4BPM',rot:'R2'},
{tipo:'POG',num:'14',sub:'A1',lat:-22.910232,lon:-43.203581,local:'Av. P.Vargas sent. centro',hub:'4BPM',rot:'R2'},
{tipo:'POG',num:'15',sub:'A1',lat:-22.910461,lon:-43.200377,local:'Rua Laura de Araujo',hub:'4BPM',rot:'R3'},
{tipo:'POG',num:'16',sub:'B2',lat:-22.914359,lon:-43.197319,local:'R. F.Caneca H.Carrilho/dispersao',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'17',sub:'A1',lat:-22.909932,lon:-43.205771,local:'Av. P.Vargas passarela Tubular',hub:'4BPM',rot:'R2'},
{tipo:'POG',num:'18',sub:'A1',lat:-22.911683,lon:-43.201914,local:'Rua Correia Vasques',hub:'4BPM',rot:'R3'},
{tipo:'POG',num:'19',sub:'A1',lat:-22.910364,lon:-43.198417,local:'Rua Pres. Barroso',hub:'4BPM',rot:'R3'},
{tipo:'POG',num:'20',sub:'A2',lat:-22.913863,lon:-43.204727,local:'R. Estacio Sa H.Beltrao/U.Guimaraes',hub:'4BPM',rot:'R1'},
{tipo:'TORRE',num:'01',sub:'A1',lat:-22.907950,lon:-43.200466,local:'Torre 1 — Prox Metro Pca XI',hub:'',rot:''},
{tipo:'TORRE',num:'02',sub:'A1',lat:-22.907471,lon:-43.199027,local:'Torre 2 — Av. Pres. Vargas',hub:'',rot:''},
{tipo:'TORRE',num:'03',sub:'A1',lat:-22.907187,lon:-43.198210,local:'Torre 3 — Av. Pres. Vargas',hub:'',rot:''},
{tipo:'TORRE',num:'04',sub:'B1',lat:-22.906732,lon:-43.196605,local:'Torre 4 — Prox Terreirao',hub:'',rot:''},
{tipo:'TORRE',num:'05',sub:'B1',lat:-22.906394,lon:-43.194517,local:'Torre 5 — R. Santana',hub:'',rot:''},
{tipo:'TORRE',num:'06',sub:'B1',lat:-22.905020,lon:-43.191754,local:'Torre 6 — Av. Pres. Vargas',hub:'',rot:''},
{tipo:'HUB',num:'1',sub:'',lat:-22.9073,lon:-43.2155,local:'Hub 1 — 4o BPM Sede (R. F.Eugenio)',hub:'',rot:''},
{tipo:'HUB',num:'2',sub:'',lat:-22.9076,lon:-43.1953,local:'Hub 2 — BPChoque (R. B.Hipolito)',hub:'',rot:''}
];

var STATUS_COLORS={PENDENTE:'#dc3545',EM_TRANSITO:'#ffc107',IMPLANTADO:'#28a745',DESMOBILIZADO:'#6c757d'};
var STATUS_NAMES={PENDENTE:'PENDENTE',EM_TRANSITO:'EM TRANSITO',IMPLANTADO:'IMPLANTADO',DESMOBILIZADO:'DESMOBILIZADO'};
var SUBAREA_COLORS={A1:'#FFD700',A2:'#C0C0C0',B1:'#00E676',B2:'#448AFF'};
var STORAGE_KEY='dashboard-carnaval-2026-v3';
var MODO='operador';
var estado={},fase='IMPLANTACAO',turno=1,turnoInicio=null,markers={},map,currentTileLayer;
var logEntries=[],MAX_LOG=30;

if(location.search.indexOf('modo=monitor')>=0)MODO='monitor';

var TILES={
dark:{url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',attr:'OSM, CARTO'},
light:{url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',attr:'OSM, CARTO'},
sat:{url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',attr:'Esri'}
};

function setTile(name){
if(currentTileLayer)map.removeLayer(currentTileLayer);
currentTileLayer=L.tileLayer(TILES[name].url,{attribution:TILES[name].attr,maxZoom:19}).addTo(map);
document.querySelectorAll('.map-btn').forEach(function(b){b.classList.remove('active')});
var id='btn'+name.charAt(0).toUpperCase()+name.slice(1);
var el=document.getElementById(id);if(el)el.classList.add('active');
localStorage.setItem('dash-tile',name);
}

function initEstado(){
if(location.hash&&location.hash.indexOf('#s=')===0){
decodeStateFromHash(location.hash.substring(3));
MODO='monitor';salvar();return;
}
var saved=localStorage.getItem(STORAGE_KEY);
if(saved){try{var d=JSON.parse(saved);estado=d.status||{};fase=d.fase||'IMPLANTACAO';turno=d.turno||1;turnoInicio=d.turnoInicio||null;logEntries=d.log||[];}catch(e){estado={};}}
DADOS.forEach(function(p){var k=p.tipo+'_'+p.num;if(!estado[k])estado[k]={status:'PENDENTE',hora:''};});
}

function salvar(){
var d={status:estado,fase:fase,turno:turno,turnoInicio:turnoInicio,log:logEntries.slice(0,MAX_LOG),ts:new Date().toISOString()};
localStorage.setItem(STORAGE_KEY,JSON.stringify(d));
document.getElementById('lastUpdate').textContent=new Date().toLocaleTimeString('pt-BR');
}

function getStatus(p){var k=p.tipo+'_'+p.num;return estado[k]?estado[k].status:'PENDENTE';}

function setStatus(p,st,silent){
var k=p.tipo+'_'+p.num;
var oldSt=estado[k]?estado[k].status:'PENDENTE';
if(oldSt===st)return;
var hora=new Date().toLocaleTimeString('pt-BR');
estado[k]={status:st,hora:hora};
if(!silent)addLog(p.tipo+' '+p.num+(p.sub?' ('+p.sub+')':''),oldSt,st,hora);
salvar();atualizarMapa();atualizarStats();
}

function addLog(label,from,to,hora){
logEntries.unshift({label:label,from:from,to:to,hora:hora});
if(logEntries.length>MAX_LOG)logEntries.pop();
renderLog();
}

function renderLog(){
var el=document.getElementById('logList');
if(!logEntries.length){el.innerHTML='<div class="log-entry"><span class="log-msg" style="color:#555">Nenhuma acao registrada</span></div>';return;}
var html='';
logEntries.slice(0,15).forEach(function(e){
var color=STATUS_COLORS[e.to]||'#888';
html+='<div class="log-entry"><span class="log-time">'+e.hora+'</span><span class="log-dot" style="background:'+color+'"></span><span class="log-msg">'+e.label+' &rarr; '+(STATUS_NAMES[e.to]||e.to)+'</span></div>';
});
el.innerHTML=html;
}

function createIcon(p){
var st=getStatus(p);var color=STATUS_COLORS[st]||'#dc3545';var svg;
if(p.tipo==='HUB'){
svg='<svg width="44" height="44" viewBox="0 0 44 44"><polygon points="22,2 27,16 42,16 30,25 34,40 22,31 10,40 14,25 2,16 17,16" fill="#FFD700" stroke="#B8860B" stroke-width="1.5"/><text x="22" y="26" text-anchor="middle" fill="#000" font-size="12" font-weight="900">H'+p.num+'</text></svg>';
return L.divIcon({html:svg,className:'',iconSize:[44,44],iconAnchor:[22,22],popupAnchor:[0,-22]});
}
if(p.tipo==='TORRE'){
svg='<svg width="22" height="34" viewBox="0 0 22 34">'
+'<line x1="11" y1="0" x2="11" y2="8" stroke="'+color+'" stroke-width="2.5"/>'
+'<line x1="6" y1="3" x2="16" y2="3" stroke="'+color+'" stroke-width="2"/>'
+'<circle cx="7" cy="3" r="1.5" fill="#fff" opacity=".6"/><circle cx="15" cy="3" r="1.5" fill="#fff" opacity=".6"/>'
+'<rect x="3" y="8" width="16" height="24" rx="2" fill="'+color+'" stroke="#fff" stroke-width="1.5"/>'
+'<rect x="6" y="10" width="10" height="6" rx="1" fill="rgba(0,0,0,0.2)"/>'
+'<rect x="7" y="11" width="3" height="4" rx=".5" fill="rgba(255,255,255,0.25)"/>'
+'<rect x="12" y="11" width="3" height="4" rx=".5" fill="rgba(255,255,255,0.25)"/>'
+'<text x="11" y="27" text-anchor="middle" fill="#fff" font-size="10" font-weight="800">'+p.num+'</text></svg>';
return L.divIcon({html:svg,className:'',iconSize:[22,34],iconAnchor:[11,32],popupAnchor:[0,-32]});
}
if(p.tipo==='POG'){
svg='<svg width="26" height="26" viewBox="0 0 26 26">'
+'<circle cx="13" cy="13" r="11" fill="'+color+'" stroke="#fff" stroke-width="1.5" stroke-dasharray="5 2.5"/>'
+'<circle cx="13" cy="13" r="7" fill="rgba(0,0,0,0.15)"/>'
+'<text x="13" y="17" text-anchor="middle" fill="#fff" font-size="10" font-weight="800">'+p.num+'</text></svg>';
return L.divIcon({html:svg,className:'',iconSize:[26,26],iconAnchor:[13,13],popupAnchor:[0,-13]});
}
var subColor=SUBAREA_COLORS[p.sub]||'#fff';
svg='<svg width="28" height="38" viewBox="0 0 28 38">'
+'<path d="M14 36 C14 36 2 22 2 13 A12 12 0 1 1 26 13 C26 22 14 36 14 36Z" fill="'+color+'" stroke="'+subColor+'" stroke-width="2.5"/>'
+'<circle cx="14" cy="13" r="7.5" fill="rgba(0,0,0,0.15)"/>'
+'<text x="14" y="17" text-anchor="middle" fill="#fff" font-size="10" font-weight="800" style="text-shadow:0 1px 2px rgba(0,0,0,.6)">'+p.num+'</text></svg>';
return L.divIcon({html:svg,className:'',iconSize:[28,38],iconAnchor:[14,36],popupAnchor:[0,-36]});
}

function popupContent(p){
var st=getStatus(p);var k=p.tipo+'_'+p.num;var hora=estado[k]?estado[k].hora:'';
var h='<div class="popup-title">'+p.tipo+' '+p.num+'</div>';
if(p.sub)h+='<div class="popup-sub">Subarea '+p.sub+(p.rot&&p.rot!=='A_PE'?' | Roteiro '+p.rot:p.rot==='A_PE'?' | A pe':'')+(p.hub?' | Hub: '+p.hub:'')+'</div>';
h+='<div class="popup-local">'+p.local+'</div>';
h+='<div class="popup-status"><span class="badge" style="background:'+STATUS_COLORS[st]+';color:'+(st==='EM_TRANSITO'?'#000':'#fff')+'">'+STATUS_NAMES[st]+'</span>';
if(hora)h+='<span class="popup-hora">'+hora+'</span>';
h+='</div>';
if(MODO==='operador'&&p.tipo!=='HUB'){
h+='<div class="popup-btns">';
if(st!=='PENDENTE')h+='<button class="btn btn-red btn-small" onclick="mudar(\''+p.tipo+'\',\''+p.num+'\',\'PENDENTE\')">Pendente</button>';
if(st!=='EM_TRANSITO')h+='<button class="btn btn-yellow btn-small" onclick="mudar(\''+p.tipo+'\',\''+p.num+'\',\'EM_TRANSITO\')">Transito</button>';
if(st!=='IMPLANTADO')h+='<button class="btn btn-green btn-small" onclick="mudar(\''+p.tipo+'\',\''+p.num+'\',\'IMPLANTADO\')">Implantado</button>';
if(st!=='DESMOBILIZADO')h+='<button class="btn btn-gray btn-small" onclick="mudar(\''+p.tipo+'\',\''+p.num+'\',\'DESMOBILIZADO\')">Desmob.</button>';
h+='</div>';
}
return h;
}

function mudar(tipo,num,st){var p=DADOS.find(function(d){return d.tipo===tipo&&d.num===num;});if(p){setStatus(p,st);map.closePopup();}}
function atualizarMapa(){DADOS.forEach(function(p){var k=p.tipo+'_'+p.num;if(markers[k]){markers[k].setIcon(createIcon(p));markers[k].setPopupContent(popupContent(p));}});}

function atualizarStats(){
var s={A1:{i:0,n:0},A2:{i:0,n:0},B1:{i:0,n:0},B2:{i:0,n:0},torres:{i:0,n:0},pogs:{i:0,n:0},mptr:{i:0,n:0},total:{i:0,n:0},transito:0};
DADOS.forEach(function(p){
var st=getStatus(p);var done=(st==='IMPLANTADO'||st==='DESMOBILIZADO')?1:0;
if(st==='EM_TRANSITO')s.transito++;
if(p.tipo==='APREV'){if(s[p.sub]){s[p.sub].n++;s[p.sub].i+=done;}s.total.n++;s.total.i+=done;if(p.rot==='MPTR'){s.mptr.n++;s.mptr.i+=done;}}
else if(p.tipo==='TORRE'){s.torres.n++;s.torres.i+=done;}
else if(p.tipo==='POG'){s.pogs.n++;s.pogs.i+=done;}
});
['A1','A2','B1','B2'].forEach(function(k){
var pct=s[k].n?Math.round(s[k].i/s[k].n*100):0;
document.getElementById('bar'+k).style.width=pct+'%';
document.getElementById('txt'+k).textContent=s[k].i+'/'+s[k].n+' ('+pct+'%)';
});
var totalPct=s.total.n?Math.round(s.total.i/s.total.n*100):0;
var el=document.getElementById('bigPct');el.textContent=totalPct+'%';
el.className='big-pct'+(totalPct<30?' low':totalPct<70?' mid':' high');
document.getElementById('statTorres').textContent=s.torres.i+'/'+s.torres.n;
document.getElementById('statPogs').textContent=s.pogs.i+'/'+s.pogs.n;
document.getElementById('statMptr').textContent=s.mptr.i+'/'+s.mptr.n;
['Torres','Pogs','Mptr'].forEach(function(name){var box=document.getElementById('box'+name);var key=name.toLowerCase();if(s[key]&&s[key].i===s[key].n&&s[key].n>0)box.classList.add('done');else box.classList.remove('done');});
document.getElementById('faseVal').textContent=fase;
var tl={1:'1o (17h-01h)',2:'2o (01h-05h)',3:'3o (06h-18h)'};
document.getElementById('turnoVal').textContent=tl[turno]||turno+'o';
var sitLines=[];
sitLines.push(s.total.i+'/'+s.total.n+' APREVs implantadas ('+totalPct+'%)');
if(s.transito>0)sitLines.push(s.transito+' em transito');
sitLines.push('Torres: '+s.torres.i+'/'+s.torres.n+' | POGs: '+s.pogs.i+'/'+s.pogs.n);
var critical=[];
['A1','A2','B1','B2'].forEach(function(k){var pct=s[k].n?Math.round(s[k].i/s[k].n*100):0;if(pct<50&&s[k].n>0)critical.push(k+' ('+pct+'%)');});
if(critical.length)sitLines.push('<span class="critical">Areas criticas: '+critical.join(', ')+'</span>');
else if(totalPct===100)sitLines.push('<span style="color:#28a745;font-weight:700">IMPLANTACAO COMPLETA</span>');
document.getElementById('sitrepText').innerHTML=sitLines.join('<br>');
}

function marcarRoteiro(rot,st){
var count=DADOS.filter(function(p){return p.tipo==='APREV'&&p.rot===rot;}).length;
if(!confirm('Marcar '+count+' APREVs do '+rot+' como '+STATUS_NAMES[st]+'?'))return;
var changed=0;
DADOS.forEach(function(p){if(p.tipo==='APREV'&&p.rot===rot){var old=getStatus(p);if(old!==st){setStatus(p,st,true);changed++;}}});
if(changed)addLog(rot+' ('+changed+' APREVs)','VARIOS',st,new Date().toLocaleTimeString('pt-BR'));
salvar();atualizarMapa();atualizarStats();renderLog();
}

function marcarRoteiroImpl(rot){
var count=DADOS.filter(function(p){return p.tipo==='APREV'&&p.rot===rot;}).length;
if(!confirm('Marcar '+count+' APREVs do '+rot+' como IMPLANTADO?'))return;
var changed=0;
DADOS.forEach(function(p){if(p.tipo==='APREV'&&p.rot===rot){var old=getStatus(p);if(old!=='IMPLANTADO'){setStatus(p,'IMPLANTADO',true);changed++;}}});
if(changed)addLog(rot+' ('+changed+' APREVs)','VARIOS','IMPLANTADO',new Date().toLocaleTimeString('pt-BR'));
salvar();atualizarMapa();atualizarStats();renderLog();
}

function marcarMPTR(){
if(!confirm('Marcar APREVs 21 e 46 (MPTR) como IMPLANTADO?'))return;
DADOS.forEach(function(p){if(p.rot==='MPTR')setStatus(p,'IMPLANTADO',true);});
addLog('MPTR (APREVs 21+46)','VARIOS','IMPLANTADO',new Date().toLocaleTimeString('pt-BR'));
salvar();atualizarMapa();atualizarStats();renderLog();
}

function alternarFase(){fase=(fase==='IMPLANTACAO')?'DESMOBILIZACAO':'IMPLANTACAO';addLog('Fase','','fase: '+fase,new Date().toLocaleTimeString('pt-BR'));salvar();atualizarStats();renderLog();}
function alternarTurno(){var old=turno;turno=turno>=3?1:turno+1;turnoInicio=new Date().toISOString();addLog('Turno',old+'o',turno+'o',new Date().toLocaleTimeString('pt-BR'));salvar();atualizarStats();renderLog();}

function resetTurno(){
if(!confirm('ZERAR TODOS OS STATUS? Esta acao nao pode ser desfeita!'))return;
if(!confirm('TEM CERTEZA? Todos os markers voltarao a PENDENTE.'))return;
DADOS.forEach(function(p){var k=p.tipo+'_'+p.num;estado[k]={status:'PENDENTE',hora:''};});
turnoInicio=new Date().toISOString();
addLog('RESET TURNO','','PENDENTE',new Date().toLocaleTimeString('pt-BR'));
logEntries=[logEntries[0]];
salvar();atualizarMapa();atualizarStats();renderLog();
}

function encodeStateForURL(){
var changes=[];
DADOS.forEach(function(p){var k=p.tipo+'_'+p.num;var st=estado[k]?estado[k].status:'PENDENTE';
if(st!=='PENDENTE'){var prefix=p.tipo==='APREV'?'A':p.tipo==='POG'?'P':p.tipo==='TORRE'?'T':'H';
var stCode=st==='IMPLANTADO'?'I':st==='EM_TRANSITO'?'E':st==='DESMOBILIZADO'?'D':'P';
changes.push(prefix+p.num+stCode);}});
return 'f'+(fase==='IMPLANTACAO'?'I':'D')+'t'+turno+(changes.length?'.'+changes.join(','):'');
}

function decodeStateFromHash(str){
var dotIdx=str.indexOf('.');var meta=dotIdx>=0?str.substring(0,dotIdx):str;
var entries=dotIdx>=0?str.substring(dotIdx+1).split(','):[];
fase=meta.indexOf('fI')>=0?'IMPLANTACAO':'DESMOBILIZACAO';
var tIdx=meta.indexOf('t');if(tIdx>=0)turno=parseInt(meta.charAt(tIdx+1))||1;
DADOS.forEach(function(p){var k=p.tipo+'_'+p.num;estado[k]={status:'PENDENTE',hora:''};});
entries.forEach(function(e){if(e.length<3)return;
var tipoMap={A:'APREV',P:'POG',T:'TORRE',H:'HUB'};
var stMap={I:'IMPLANTADO',E:'EM_TRANSITO',D:'DESMOBILIZADO',P:'PENDENTE'};
var tipo=tipoMap[e.charAt(0)];var stCode=e.charAt(e.length-1);var num=e.substring(1,e.length-1);
if(tipo&&stMap[stCode]){estado[tipo+'_'+num]={status:stMap[stCode],hora:''};}});
}

function compartilharLink(){
var encoded=encodeStateForURL();var baseUrl=location.origin+location.pathname;
var monitorUrl=baseUrl+'?modo=monitor#s='+encoded;
if(navigator.clipboard){navigator.clipboard.writeText(monitorUrl).then(function(){
var el=document.getElementById('shareUrl');el.textContent='Link copiado! Cole no WhatsApp para o Comando visualizar.';el.style.display='block';
setTimeout(function(){el.style.display='none';},5000);});}
if(navigator.share){navigator.share({title:'4o BPM — Carnaval 2026',text:'Painel Tatico — '+fase+' — Turno '+turno,url:monitorUrl}).catch(function(){});}
}

function exportarJSON(){
var d={status:estado,fase:fase,turno:turno,ts:new Date().toISOString()};var json=JSON.stringify(d);
if(navigator.clipboard){navigator.clipboard.writeText(json).then(function(){alert('JSON copiado!');});}
else{var ta=document.getElementById('importArea');ta.style.display='block';ta.value=json;ta.select();}
}

function toggleImport(){var ta=document.getElementById('importArea');var btn=document.getElementById('btnAplicar');var show=ta.style.display!=='block';ta.style.display=show?'block':'none';btn.style.display=show?'block':'none';}

function importarEstado(){
var ta=document.getElementById('importArea');var val=ta.value.trim();
if(val.indexOf('#s=')>=0){var hash=val.substring(val.indexOf('#s=')+3);decodeStateFromHash(hash);salvar();atualizarMapa();atualizarStats();alert('Estado importado do link!');ta.style.display='none';document.getElementById('btnAplicar').style.display='none';return;}
try{var d=JSON.parse(val);if(d.status){estado=d.status;fase=d.fase||fase;turno=d.turno||turno;}salvar();atualizarMapa();atualizarStats();alert('Estado importado!');ta.style.display='none';document.getElementById('btnAplicar').style.display='none';}
catch(e){alert('Formato invalido! Use JSON ou link compartilhado.');}
}

function atualizarTimer(){if(!turnoInicio)return;var diff=Date.now()-new Date(turnoInicio).getTime();var h=Math.floor(diff/3600000);var m=Math.floor((diff%3600000)/60000);document.getElementById('timerVal').textContent=h+'h'+(m<10?'0':'')+m+'m';}

function init(){
initEstado();
if(MODO==='monitor'){
document.getElementById('monitor-banner').classList.add('active');
document.getElementById('controlsDiv').style.display='none';
document.getElementById('shareDiv').style.display='none';
setInterval(function(){
if(location.hash&&location.hash.indexOf('#s=')===0){decodeStateFromHash(location.hash.substring(3));}
else{var saved=localStorage.getItem(STORAGE_KEY);if(saved){try{var d=JSON.parse(saved);estado=d.status||estado;fase=d.fase||fase;turno=d.turno||turno;logEntries=d.log||logEntries;}catch(e){}}}
atualizarMapa();atualizarStats();renderLog();
},5000);
}
map=L.map('map',{zoomControl:true,attributionControl:false}).setView([-22.9100,-43.1990],15);
L.control.attribution({position:'bottomright',prefix:false}).addTo(map);
var savedTile=localStorage.getItem('dash-tile')||'dark';
setTile(savedTile);
DADOS.forEach(function(p){
var k=p.tipo+'_'+p.num;
var zOff=p.tipo==='HUB'?1000:p.tipo==='TORRE'?800:p.tipo==='APREV'?500:300;
var m=L.marker([p.lat,p.lon],{icon:createIcon(p),zIndexOffset:zOff});
m.bindPopup(popupContent(p),{maxWidth:300,closeButton:true});
m.addTo(map);markers[k]=m;
});
atualizarStats();renderLog();
document.getElementById('lastUpdate').textContent=new Date().toLocaleTimeString('pt-BR');
if(!turnoInicio)turnoInicio=new Date().toISOString();
atualizarTimer();setInterval(atualizarTimer,60000);
}

document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>