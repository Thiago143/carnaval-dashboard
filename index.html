<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0d0d1a">
<title>4o BPM - Carnaval 2026 - Painel Tatico</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#127919;</text></svg>">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;background:#0d0d1a;color:#e0e0e0;overflow:hidden;height:100vh}
:root{--red:#dc3545;--yellow:#ffc107;--green:#28a745;--gray:#6c757d;--blue:#448AFF;--purple:#9b59b6;--dark:#0d0d1a;--panel:#141428;--border:#1e3a5f;--accent:#e94560;--text:#e0e0e0;--muted:#888;--sidebar-w:320px}
#sidebar{position:fixed;left:0;top:0;width:var(--sidebar-w);height:100vh;background:linear-gradient(180deg,#141428 0%,#0f1f35 100%);z-index:1000;overflow-y:auto;overflow-x:hidden;border-right:2px solid var(--border);display:flex;flex-direction:column;scrollbar-width:thin;scrollbar-color:var(--border) transparent}
#sidebar::-webkit-scrollbar{width:5px}
#sidebar::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
#map{position:fixed;left:var(--sidebar-w);top:0;right:0;bottom:0}
.header{background:linear-gradient(135deg,#0f3460,#1a1a4e);padding:14px 16px;text-align:center;border-bottom:2px solid var(--accent)}
.header h1{font-size:15px;color:#fff;letter-spacing:1.5px;font-weight:800}
.header h2{font-size:11px;color:var(--accent);margin-top:3px;font-weight:500;letter-spacing:0.5px}
.turno-bar{display:flex;justify-content:space-between;align-items:center;padding:8px 16px;background:rgba(15,52,96,0.4);border-bottom:1px solid var(--border)}
.turno-bar span{font-size:12px;color:var(--muted)}
.turno-bar .val{color:var(--accent);font-weight:700}
.turno-bar .timer{color:#ffc107;font-weight:600;font-size:11px}
.sitrep{padding:10px 16px;background:rgba(40,167,69,0.08);border-bottom:1px solid var(--border);font-size:11px;line-height:1.5}
.sitrep .sitrep-title{color:var(--accent);font-weight:700;font-size:10px;text-transform:uppercase;letter-spacing:1.5px;margin-bottom:4px}
.sitrep .sitrep-text{color:#ccc}
.sitrep .critical{color:var(--red);font-weight:600}
.section{padding:10px 16px}
.section-title{font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:4px;font-weight:600}
.stat-row{display:flex;align-items:center;margin-bottom:5px;font-size:12px}
.stat-label{width:30px;font-weight:700;text-align:center;border-radius:4px;padding:3px 0;margin-right:8px;font-size:10px}
.stat-bar-bg{flex:1;height:20px;background:rgba(255,255,255,0.04);border-radius:10px;overflow:hidden;position:relative;border:1px solid rgba(255,255,255,0.06);display:flex;align-items:center}
.stat-bar{height:100%;border-radius:10px;transition:width .6s cubic-bezier(.4,0,.2,1)}
.stat-text{position:absolute;right:8px;font-size:10px;color:#fff;font-weight:700;text-shadow:0 1px 3px rgba(0,0,0,.8)}
.big-pct-wrap{text-align:center;padding:8px 16px}
.big-pct{font-size:48px;font-weight:900;transition:color .5s}
.big-pct.low{color:var(--red);text-shadow:0 0 30px rgba(220,53,69,.25)}
.big-pct.mid{color:var(--yellow);text-shadow:0 0 30px rgba(255,193,7,.2)}
.big-pct.high{color:var(--green);text-shadow:0 0 30px rgba(40,167,69,.25)}
.extra-stats{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;padding:0 16px 8px}
.extra-box{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:8px 4px;text-align:center;transition:border-color .3s}
.extra-box .num{font-size:20px;font-weight:800}
.extra-box .lbl{font-size:8px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:2px}
.extra-box.done{border-color:var(--green)}
.btn{display:block;width:100%;padding:9px;margin-bottom:5px;border:none;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;transition:all .15s;text-transform:uppercase;letter-spacing:0.5px;-webkit-tap-highlight-color:transparent}
.btn:hover{transform:translateY(-1px);filter:brightness(1.1)}
.btn:active{transform:translateY(0);filter:brightness(0.95)}
.btn-red{background:linear-gradient(135deg,#dc3545,#c82333);color:#fff}
.btn-yellow{background:linear-gradient(135deg,#ffc107,#e0a800);color:#1a1a2e}
.btn-green{background:linear-gradient(135deg,#28a745,#218838);color:#fff}
.btn-blue{background:linear-gradient(135deg,#448AFF,#2979FF);color:#fff}
.btn-gray{background:linear-gradient(135deg,#6c757d,#5a6268);color:#fff}
.btn-purple{background:linear-gradient(135deg,#9b59b6,#8e44ad);color:#fff}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-small{display:inline-block;width:auto;padding:5px 12px;font-size:10px;margin:2px}
.btn-group{display:flex;gap:4px;margin-bottom:5px}
.btn-group .btn{margin-bottom:0;flex:1}
.log-list{max-height:120px;overflow-y:auto;scrollbar-width:thin}
.log-entry{font-size:10px;padding:3px 0;border-bottom:1px solid rgba(255,255,255,0.03);display:flex;align-items:center;gap:6px}
.log-entry .log-time{color:var(--accent);font-weight:600;min-width:40px}
.log-entry .log-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.log-entry .log-msg{color:#bbb}
.legend{padding:8px 16px}
.legend-grid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.legend-item{display:flex;align-items:center;font-size:10px;color:var(--muted);gap:5px}
.footer{padding:8px 16px;background:rgba(0,0,0,.3);border-top:1px solid var(--border);font-size:10px;color:#555;text-align:center;margin-top:auto}
.footer .ts{color:var(--accent)}
.share-section{padding:8px 16px;border-top:1px solid var(--border)}
.share-section textarea{width:100%;height:50px;background:var(--dark);color:var(--text);border:1px solid var(--border);border-radius:6px;font-size:10px;font-family:monospace;padding:6px;resize:none;display:none;margin-top:4px}
.share-url{font-size:10px;color:var(--green);padding:4px 0;word-break:break-all;display:none}
.leaflet-popup-content-wrapper{background:#1a1a2e;color:var(--text);border:1px solid var(--border);border-radius:10px;box-shadow:0 8px 30px rgba(0,0,0,.5)}
.leaflet-popup-tip{background:#1a1a2e;border:1px solid var(--border)}
.leaflet-popup-content{margin:12px 14px;font-size:12px;line-height:1.5}
.popup-title{font-size:15px;font-weight:800;margin-bottom:2px}
.popup-sub{font-size:11px;color:var(--muted);margin-bottom:2px}
.popup-local{font-size:11px;color:#aaa;margin-bottom:8px}
.popup-status{font-size:12px;margin-bottom:10px}
.popup-status .badge{font-weight:700;padding:3px 10px;border-radius:4px;font-size:11px;display:inline-block}
.popup-hora{font-size:10px;color:var(--muted);margin-left:6px}
.popup-btns{display:flex;gap:4px;flex-wrap:wrap}
.popup-btns .btn{width:auto;padding:6px 12px;font-size:10px;margin:0;min-width:60px}
.monitor-banner{background:var(--red);color:#fff;text-align:center;padding:8px;font-size:13px;font-weight:800;letter-spacing:3px;display:none;animation:pulse 2s infinite}
.monitor-banner.active{display:block}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.map-controls{position:fixed;top:10px;right:10px;z-index:1001;display:flex;gap:6px}
.map-btn{background:var(--panel);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-size:11px;cursor:pointer;font-weight:600}
.map-btn:hover{border-color:var(--accent)}
.map-btn.active{border-color:var(--accent);color:var(--accent)}
@media(max-width:768px){
:root{--sidebar-w:100vw}
#sidebar{width:100%;height:auto;max-height:42vh;position:relative;border-right:none;border-bottom:2px solid var(--border)}
#map{position:relative;left:0;height:58vh;width:100%}
body{overflow-y:auto;height:auto}
.header h1{font-size:13px}
.big-pct{font-size:36px}
.map-controls{top:auto;bottom:10px}
}

.chip-route{margin-bottom:10px}
.chip-route-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.chip-route-title{font-size:10px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:1px}
.chip-route-count{font-size:10px;color:var(--accent);font-weight:700}
.chip-grid{display:flex;flex-wrap:wrap;gap:3px}
.chip{display:inline-flex;align-items:center;justify-content:center;min-width:32px;height:28px;padding:0 5px;border-radius:6px;font-size:10px;font-weight:800;color:#fff;cursor:pointer;transition:all .12s;-webkit-tap-highlight-color:transparent;border:2px solid transparent;font-family:Arial,sans-serif;user-select:none}
.chip:active{transform:scale(0.88)}
.chip-P{background:var(--red)}
.chip-E{background:var(--yellow);color:#000}
.chip-I{background:var(--green)}
.chip-D{background:var(--gray)}
.chip-flash{animation:chipflash .4s}
@keyframes chipflash{0%{transform:scale(1.3);box-shadow:0 0 12px #28a745}100%{transform:scale(1);box-shadow:none}}
.route-saida-btn{display:inline-flex;align-items:center;gap:4px;padding:6px 12px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;border:none;color:#000;background:linear-gradient(135deg,#ffc107,#e0a800);transition:all .15s;-webkit-tap-highlight-color:transparent}
.route-saida-btn:active{transform:scale(0.95)}
.route-saida-btn.saiu{background:linear-gradient(135deg,#ffc107,#ff9800);opacity:0.6;text-decoration:line-through}
.route-saida-grid{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:8px}
</style>
</head>
<body>
<div id="monitor-banner" class="monitor-banner">MODO VISUALIZACAO — DADOS ATUALIZAM AUTOMATICAMENTE</div>
<div id="sidebar">
<div class="header"><h1>4o BPM — CARNAVAL 2026</h1><h2>PAINEL TATICO — SAMBODROMO</h2></div>
<div class="turno-bar">
<span>Turno: <span class="val" id="turnoVal">1o (17h-01h)</span></span>
<span>Fase: <span class="val" id="faseVal">IMPLANTACAO</span></span>
<span class="timer" id="timerVal"></span>
</div>
<div class="sitrep" id="sitrepDiv"><div class="sitrep-title">SITREP</div><div class="sitrep-text" id="sitrepText">Aguardando dados...</div></div>
<div class="section">
<div class="section-title">Progresso por Subarea</div>
<div class="stat-row"><div class="stat-label" style="background:#FFD700;color:#000">A1</div><div class="stat-bar-bg"><div class="stat-bar" id="barA1" style="width:0%;background:linear-gradient(90deg,#FFD700,#FFA000)"></div><span class="stat-text" id="txtA1">0/16</span></div></div>
<div class="stat-row"><div class="stat-label" style="background:#C0C0C0;color:#000">A2</div><div class="stat-bar-bg"><div class="stat-bar" id="barA2" style="width:0%;background:linear-gradient(90deg,#C0C0C0,#9E9E9E)"></div><span class="stat-text" id="txtA2">0/8</span></div></div>
<div class="stat-row"><div class="stat-label" style="background:#00E676;color:#000">B1</div><div class="stat-bar-bg"><div class="stat-bar" id="barB1" style="width:0%;background:linear-gradient(90deg,#00E676,#00C853)"></div><span class="stat-text" id="txtB1">0/12</span></div></div>
<div class="stat-row"><div class="stat-label" style="background:#448AFF;color:#fff">B2</div><div class="stat-bar-bg"><div class="stat-bar" id="barB2" style="width:0%;background:linear-gradient(90deg,#448AFF,#2962FF)"></div><span class="stat-text" id="txtB2">0/16</span></div></div>
</div>
<div class="big-pct-wrap"><div class="big-pct low" id="bigPct">0%</div></div>
<div class="extra-stats">
<div class="extra-box" id="boxTorres"><div class="num" id="statTorres">0/6</div><div class="lbl">Torres</div></div>
<div class="extra-box" id="boxPogs"><div class="num" id="statPogs">0/20</div><div class="lbl">POGs</div></div>
<div class="extra-box" id="boxMptr"><div class="num" id="statMptr">0/2</div><div class="lbl">MPTR</div></div>
</div>
<div class="section" id="controlsDiv">
<div class="section-title">Saida de Rotas <span style="font-weight:400;color:#666">(EM TRANSITO)</span></div>
<div class="route-saida-grid">
<button class="route-saida-btn" id="btn_R1" onclick="saidaRota('R1')">R1 Saiu</button>
<button class="route-saida-btn" id="btn_R2" onclick="saidaRota('R2')">R2 Saiu</button>
<button class="route-saida-btn" id="btn_R3" onclick="saidaRota('R3')">R3 Saiu</button>
<button class="route-saida-btn" id="btn_A_PE" onclick="saidaRota('A_PE')">BPChq A Pe</button>
<button class="route-saida-btn" id="btn_MPTR" onclick="saidaRota('MPTR')">MPTR</button>
</div>
<div style="margin-top:6px">
<div class="section-title">Assuncao Individual <span style="font-weight:400;color:#666">(toque = implantado)</span></div>
<div id="chipContainer"></div>
</div>
<div style="margin-top:10px"><div class="section-title">Fase / Turno</div>
<div class="btn-group">
<button class="btn btn-outline" onclick="alternarFase()">Alternar Fase</button>
<button class="btn btn-outline" onclick="alternarTurno()">Proximo Turno</button>
</div>
<button class="btn btn-red btn-small" onclick="resetTurno()" style="width:100%;margin-top:4px">Reset Turno (Zerar Tudo)</button>
</div></div>
<div class="share-section" id="shareDiv">
<div class="section-title">Compartilhar com Comando</div>
<button class="btn btn-blue" onclick="compartilharLink()">Copiar Link para Comando</button>
<div class="share-url" id="shareUrl"></div>
<div class="btn-group" style="margin-top:4px">
<button class="btn btn-outline btn-small" onclick="exportarJSON()">Exportar JSON</button>
<button class="btn btn-outline btn-small" onclick="toggleImport()">Importar</button>
</div>
<textarea id="importArea" placeholder="Cole o JSON ou link aqui..."></textarea>
<button class="btn btn-green btn-small" id="btnAplicar" style="display:none;width:100%;margin-top:4px" onclick="importarEstado()">Aplicar</button>
</div>
<div class="section" id="logSection"><div class="section-title">Log Recente</div><div class="log-list" id="logList"><div class="log-entry"><span class="log-msg" style="color:#555">Nenhuma acao registrada</span></div></div></div>
<div class="legend"><div class="section-title">Legenda</div>
<div class="legend-grid">
<div class="legend-item"><svg width="14" height="14"><circle cx="7" cy="7" r="6" fill="#dc3545"/></svg> Pendente</div>
<div class="legend-item"><svg width="14" height="14"><circle cx="7" cy="7" r="6" fill="#ffc107"/></svg> Em Transito</div>
<div class="legend-item"><svg width="14" height="14"><circle cx="7" cy="7" r="6" fill="#28a745"/></svg> Implantado</div>
<div class="legend-item"><svg width="14" height="14"><circle cx="7" cy="7" r="6" fill="#6c757d"/></svg> Desmobilizado</div>
</div>
<div class="legend-grid" style="margin-top:6px">
<div class="legend-item"><svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#888" stroke="#fff" stroke-width="1.5"/><svg x="3" y="3" width="14" height="14" viewBox="0 0 24 24"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z" fill="#fff"/></svg></svg> APREV</div>
<div class="legend-item"><svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#888" stroke="#fff" stroke-width="1.5"/><svg x="3" y="3" width="14" height="14" viewBox="0 0 24 24"><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7" fill="#fff"/></svg></svg> POG</div>
<div class="legend-item"><svg width="20" height="20" viewBox="0 0 20 20"><circle cx="10" cy="10" r="9" fill="#888" stroke="#fff" stroke-width="1.5"/><svg x="3" y="3" width="14" height="14" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z" fill="#fff"/></svg></svg> Torre</div>
<div class="legend-item"><svg width="20" height="20" viewBox="0 0 20 20"><polygon points="10,1 12.5,7.5 19,7.5 14,12 16,19 10,14.5 4,19 6,12 1,7.5 7.5,7.5" fill="#FFD700" stroke="#B8860B" stroke-width="0.5"/></svg> Hub</div>
</div>
<div style="margin-top:6px;font-size:9px;color:#555">Cor do marcador = status | Icone = tipo</div>

</div>
<div class="footer"><span id="sheetStatus" style="color:#dc3545;font-size:9px">Offline (localStorage)</span><br>Ultima atualizacao: <span class="ts" id="lastUpdate">--</span><br><span style="color:#444">4o BPM — Sambodromo — Carnaval 2026</span></div>
</div>
<div class="map-controls" id="mapControls">
<button class="map-btn active" onclick="setTile('dark')" id="btnDark">Noturno</button>
<button class="map-btn" onclick="setTile('light')" id="btnLight">Diurno</button>
<button class="map-btn" onclick="setTile('sat')" id="btnSat">Satelite</button>
</div>
<div id="map"></div>
<script>
var DADOS=[
{tipo:'APREV',num:'01',sub:'B2',lat:-22.909049,lon:-43.188747,local:'R. Frei Caneca c/ Pca Republica',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'02',sub:'B1',lat:-22.905428,lon:-43.190713,local:'Av. Pres. Vargas c/ Pca Republica',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'03',sub:'B1',lat:-22.905971,lon:-43.192781,local:'Av. Pres. Vargas c/ R. Gal. Caldwell',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'04',sub:'B1',lat:-22.906118,lon:-43.194840,local:'Av. Pres. Vargas c/ R. Santana ZN',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'05',sub:'B1',lat:-22.907256,lon:-43.190262,local:'Pca Republica c/ R. Moncorvo Filho',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'06',sub:'B1',lat:-22.909121,lon:-43.191858,local:'R. Gal. Caldwell c/ R. Moncorvo Filho',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'07',sub:'B1',lat:-22.906929,lon:-43.192519,local:'R. Frederico Silva c/ R. Gal. Caldwell',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'08',sub:'B1',lat:-22.907530,lon:-43.194252,local:'R. Benedito Hipolito c/ R. Santana',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'09',sub:'B2',lat:-22.911417,lon:-43.191381,local:'Av. Mem de Sa c/ R. do Senado',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'10',sub:'B2',lat:-22.910980,lon:-43.192931,local:'Av. Mem de Sa c/ R. Frei Caneca',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'11',sub:'B2',lat:-22.912982,lon:-43.191321,local:'Av. Riachuelo c/ Av. H. Valadares',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'12',sub:'B2',lat:-22.911242,lon:-43.193456,local:'R. Frei Caneca c/ R. Mqs Pombal',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'13',sub:'B1',lat:-22.907660,lon:-43.195389,local:'R. B. Hipolito c/ R. Mqs Pombal',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'14',sub:'B2',lat:-22.911484,lon:-43.195358,local:'R. Salvador Sa c/ Rampa Vd 31 Marco',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'15',sub:'B1',lat:-22.906426,lon:-43.197728,local:'Vd S.Pedro c/ Vd 31 de Marco',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'16',sub:'B2',lat:-22.912524,lon:-43.195293,local:'R. F.Caneca emb. Vd 31 Marco',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'17',sub:'B2',lat:-22.916010,lon:-43.193800,local:'R. F.Caneca c/ R. Eleone Almeida',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'18',sub:'B1',lat:-22.906425,lon:-43.195998,local:'Av. P.Vargas ZN acesso Vd 31 Marco',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'19',sub:'B1',lat:-22.904586,lon:-43.190205,local:'Av. P.Vargas c/ R. B.Ribeiro ZN',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'20',sub:'B2',lat:-22.910171,lon:-43.191522,local:'R. Gal. Caldwell c/ R. Frei Caneca',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'21',sub:'B2',lat:-22.920491,lon:-43.193768,local:'Saida Tunel Sta Barbara',hub:'MPTR',rot:'MPTR'},
{tipo:'APREV',num:'22',sub:'B2',lat:-22.917835,lon:-43.194818,local:'R. Dr. Lagden c/ R. Itapiru',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'23',sub:'B2',lat:-22.914204,lon:-43.196744,local:'R. F.Caneca c/ R. Sr Matosinhos',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'24',sub:'A1',lat:-22.907562,lon:-43.199529,local:'Av. P.Vargas ZN prox Estacio',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'25',sub:'A1',lat:-22.909154,lon:-43.204447,local:'Av. P.Vargas ZN prox pto onibus',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'26',sub:'B2',lat:-22.912086,lon:-43.197484,local:'Tv. 11 Maio c/ Av. Salvador Sa',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'27',sub:'A2',lat:-22.913008,lon:-43.202825,local:'R. Salvador Sa c/ R. F.Caneca',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'28',sub:'A2',lat:-22.914458,lon:-43.198592,local:'R. F.Caneca c/ R. A.Benevolo',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'29',sub:'A1',lat:-22.909417,lon:-43.198472,local:'R. Pres. Barroso c/ R. J.Carmo',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'30',sub:'A1',lat:-22.912530,lon:-43.205169,local:'R. U.Guimaraes c/ R. H.Beltrao',hub:'4BPM',rot:'R1'},
{tipo:'APREV',num:'31',sub:'A1',lat:-22.909974,lon:-43.200564,local:'R. Laura Araujo e/f Metro PcaXI',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'32',sub:'A1',lat:-22.908589,lon:-43.200632,local:'Av. P.Vargas Centro c/ R. C.Neto',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'33',sub:'A1',lat:-22.909782,lon:-43.204332,local:'Av. P.Vargas e/f Correios',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'34',sub:'A1',lat:-22.909838,lon:-43.202243,local:'R. A.Lima c/ R. Af. Cavalcanti',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'35',sub:'A2',lat:-22.913813,lon:-43.200823,local:'R. F.Caneca c/ R. Pirassununga',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'36',sub:'A2',lat:-22.912392,lon:-43.199423,local:'Av. Salvador Sa c/ R. C.Neto',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'37',sub:'A1',lat:-22.912932,lon:-43.209673,local:'R. J.Palhares c/ Av. P.Frontin',hub:'4BPM',rot:'R1'},
{tipo:'APREV',num:'38',sub:'A1',lat:-22.910857,lon:-43.205660,local:'R. Af. Cavalcanti e/f Prefeitura',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'39',sub:'A2',lat:-22.912509,lon:-43.200101,local:'R. Laura Araujo c/ Av. Salvador',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'40',sub:'B2',lat:-22.914215,lon:-43.196095,local:'R. F.Caneca c/ R. Catumbi',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'41',sub:'A2',lat:-22.914551,lon:-43.207573,local:'R. J.Palhares c/ R. J.Paulo Io',hub:'4BPM',rot:'R1'},
{tipo:'APREV',num:'42',sub:'A1',lat:-22.911455,lon:-43.201812,local:'R. C.Vasques c/ R. Sta Maria',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'43',sub:'A1',lat:-22.907386,lon:-43.199240,local:'Av. P.Vargas ZN apoio GM',hub:'4BPM',rot:'R2'},
{tipo:'APREV',num:'44',sub:'A1',lat:-22.910941,lon:-43.198920,local:'R. S.Martinho c/ R. A.Benevolo',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'45',sub:'A1',lat:-22.910832,lon:-43.198422,local:'R. Pres. Barroso c/ R. S.Martinho',hub:'4BPM',rot:'R3'},
{tipo:'APREV',num:'46',sub:'A2',lat:-22.935017,lon:-43.209576,local:'Entrada Tunel Reboucas',hub:'MPTR',rot:'MPTR'},
{tipo:'APREV',num:'47',sub:'A2',lat:-22.914233,lon:-43.205022,local:'R. Estacio Sa c/ R. M.Lacerda',hub:'4BPM',rot:'R1'},
{tipo:'APREV',num:'48',sub:'B1',lat:-22.908148,lon:-43.196443,local:'Terreirao Samba — Carro Cmd',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'49',sub:'B2',lat:-22.915623,lon:-43.193655,local:'R. J.Alencar c/ R. E.Almeida',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'50',sub:'B2',lat:-22.917019,lon:-43.195136,local:'R. Catumbi c/ R. Chichorro',hub:'BPChq',rot:'A_PE'},
{tipo:'APREV',num:'51',sub:'A1',lat:-22.906899,lon:-43.210238,local:'R. F.Bicalho c/ R. F.Eugenio',hub:'4BPM',rot:'R1'},
{tipo:'APREV',num:'52',sub:'A1',lat:-22.910628,lon:-43.208406,local:'Sob Viaduto dos Pracinhas',hub:'4BPM',rot:'R1'},
{tipo:'POG',num:'01',sub:'B1',lat:-22.909678,lon:-43.194363,local:'Rua Marques de Pombal',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'02',sub:'B1',lat:-22.906926,lon:-43.197484,local:'Av. P.Vargas Vd31 ate R.Santana',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'03',sub:'B1',lat:-22.907990,lon:-43.196120,local:'R. B.Hipolito bilheteria/R.Santana',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'04',sub:'B1',lat:-22.909778,lon:-43.196571,local:'Vd 31 Marco sent tunel StaBarbara',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'05',sub:'B1',lat:-22.908810,lon:-43.193702,local:'R. Santana P.Vargas/F.Caneca',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'06',sub:'B2',lat:-22.913968,lon:-43.195599,local:'R. F.Caneca dispersao P.Matos',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'07',sub:'A1',lat:-22.907306,lon:-43.215524,local:'R. Francisco Eugenio (2 sent)',hub:'4BPM',rot:'R1'},
{tipo:'POG',num:'08',sub:'A1',lat:-22.913343,lon:-43.209794,local:'Av. P.Frontin C4/1 ate Sulamerica',hub:'4BPM',rot:'R3'},
{tipo:'POG',num:'09',sub:'A2',lat:-22.912816,lon:-43.201580,local:'Av. Salvador Sa N.Pinheiro/Laura',hub:'4BPM',rot:'R1'},
{tipo:'POG',num:'10',sub:'A1',lat:-22.910872,lon:-43.203424,local:'R. Julio Carmo P.Azevedo/C.Vasques',hub:'4BPM',rot:'R2'},
{tipo:'POG',num:'11',sub:'A1',lat:-22.912297,lon:-43.204714,local:'R. Ulysses Guimaraes COR-RJ',hub:'4BPM',rot:'R1'},
{tipo:'POG',num:'12',sub:'B1',lat:-22.908260,lon:-43.197011,local:'R. B.Hipolito Vd31/Terreirao',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'13',sub:'A1',lat:-22.910852,lon:-43.206891,local:'Av. P.Vargas escada Cidade Nova',hub:'4BPM',rot:'R2'},
{tipo:'POG',num:'14',sub:'A1',lat:-22.910232,lon:-43.203581,local:'Av. P.Vargas sent. centro',hub:'4BPM',rot:'R2'},
{tipo:'POG',num:'15',sub:'A1',lat:-22.910461,lon:-43.200377,local:'Rua Laura de Araujo',hub:'4BPM',rot:'R3'},
{tipo:'POG',num:'16',sub:'B2',lat:-22.914359,lon:-43.197319,local:'R. F.Caneca H.Carrilho/dispersao',hub:'BPChq',rot:'A_PE'},
{tipo:'POG',num:'17',sub:'A1',lat:-22.909932,lon:-43.205771,local:'Av. P.Vargas passarela Tubular',hub:'4BPM',rot:'R2'},
{tipo:'POG',num:'18',sub:'A1',lat:-22.911683,lon:-43.201914,local:'Rua Correia Vasques',hub:'4BPM',rot:'R3'},
{tipo:'POG',num:'19',sub:'A1',lat:-22.910364,lon:-43.198417,local:'Rua Pres. Barroso',hub:'4BPM',rot:'R3'},
{tipo:'POG',num:'20',sub:'A2',lat:-22.913863,lon:-43.204727,local:'R. Estacio Sa H.Beltrao/U.Guimaraes',hub:'4BPM',rot:'R1'},
{tipo:'TORRE',num:'01',sub:'A1',lat:-22.907950,lon:-43.200466,local:'Torre 1 — Prox Metro Pca XI',hub:'',rot:''},
{tipo:'TORRE',num:'02',sub:'A1',lat:-22.907471,lon:-43.199027,local:'Torre 2 — Av. Pres. Vargas',hub:'',rot:''},
{tipo:'TORRE',num:'03',sub:'A1',lat:-22.907187,lon:-43.198210,local:'Torre 3 — Av. Pres. Vargas',hub:'',rot:''},
{tipo:'TORRE',num:'04',sub:'B1',lat:-22.906732,lon:-43.196605,local:'Torre 4 — Prox Terreirao',hub:'',rot:''},
{tipo:'TORRE',num:'05',sub:'B1',lat:-22.906394,lon:-43.194517,local:'Torre 5 — R. Santana',hub:'',rot:''},
{tipo:'TORRE',num:'06',sub:'B1',lat:-22.905020,lon:-43.191754,local:'Torre 6 — Av. Pres. Vargas',hub:'',rot:''},
{tipo:'HUB',num:'1',sub:'',lat:-22.9073,lon:-43.2155,local:'Hub 1 — 4o BPM Sede (R. F.Eugenio)',hub:'',rot:''},
{tipo:'HUB',num:'2',sub:'',lat:-22.9076,lon:-43.1953,local:'Hub 2 — BPChoque (R. B.Hipolito)',hub:'',rot:''}
];

var STATUS_COLORS={PENDENTE:'#dc3545',EM_TRANSITO:'#ffc107',IMPLANTADO:'#28a745',DESMOBILIZADO:'#6c757d'};
var STATUS_NAMES={PENDENTE:'PENDENTE',EM_TRANSITO:'EM TRANSITO',IMPLANTADO:'IMPLANTADO',DESMOBILIZADO:'DESMOBILIZADO'};
var SUBAREA_COLORS={A1:'#FFD700',A2:'#C0C0C0',B1:'#00E676',B2:'#448AFF'};
var STORAGE_KEY='dashboard-carnaval-2026-v3';
var MODO='viewer';
var estado={},fase='IMPLANTACAO',turno=1,turnoInicio=null,markers={},map,currentTileLayer;
var logEntries=[],MAX_LOG=30;

if(location.search.indexOf('modo=editor')>=0)MODO='editor';
else if(location.search.indexOf('modo=monitor')>=0)MODO='viewer';

var TILES={
dark:{url:'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',attr:'OSM, CARTO'},
light:{url:'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',attr:'OSM, CARTO'},
sat:{url:'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',attr:'Esri'}
};

function setTile(name){
if(currentTileLayer)map.removeLayer(currentTileLayer);
currentTileLayer=L.tileLayer(TILES[name].url,{attribution:TILES[name].attr,maxZoom:19}).addTo(map);
document.querySelectorAll('.map-btn').forEach(function(b){b.classList.remove('active')});
var id='btn'+name.charAt(0).toUpperCase()+name.slice(1);
var el=document.getElementById(id);if(el)el.classList.add('active');
localStorage.setItem('dash-tile',name);
}

function initEstado(){
if(location.hash&&location.hash.indexOf('#s=')===0){
decodeStateFromHash(location.hash.substring(3));
MODO='viewer';salvar();return;
}
var saved=localStorage.getItem(STORAGE_KEY);
if(saved){try{var d=JSON.parse(saved);estado=d.status||{};fase=d.fase||'IMPLANTACAO';turno=d.turno||1;turnoInicio=d.turnoInicio||null;logEntries=d.log||[];}catch(e){estado={};}}
DADOS.forEach(function(p){var k=p.tipo+'_'+p.num;if(!estado[k])estado[k]={status:'PENDENTE',hora:''};});
}

function salvar(){
var d={status:estado,fase:fase,turno:turno,turnoInicio:turnoInicio,log:logEntries.slice(0,MAX_LOG),ts:new Date().toISOString()};
localStorage.setItem(STORAGE_KEY,JSON.stringify(d));
document.getElementById('lastUpdate').textContent=new Date().toLocaleTimeString('pt-BR');
}

function getStatus(p){var k=p.tipo+'_'+p.num;return estado[k]?estado[k].status:'PENDENTE';}

function setStatus(p,st,silent){
var k=p.tipo+'_'+p.num;
var oldSt=estado[k]?estado[k].status:'PENDENTE';
if(oldSt===st)return;
var hora=new Date().toLocaleTimeString('pt-BR');
estado[k]={status:st,hora:hora};
if(!silent)addLog(p.tipo+' '+p.num+(p.sub?' ('+p.sub+')':''),oldSt,st,hora);
salvar();atualizarMapa();atualizarStats();
if(MODO==='editor'){syncToSheet(p.tipo,p.num,st);updateChip(p.tipo,p.num);}
}

function addLog(label,from,to,hora){
logEntries.unshift({label:label,from:from,to:to,hora:hora});
if(logEntries.length>MAX_LOG)logEntries.pop();
renderLog();
}

function renderLog(){
var el=document.getElementById('logList');
if(!logEntries.length){el.innerHTML='<div class="log-entry"><span class="log-msg" style="color:#555">Nenhuma acao registrada</span></div>';return;}
var html='';
logEntries.slice(0,15).forEach(function(e){
var color=STATUS_COLORS[e.to]||'#888';
html+='<div class="log-entry"><span class="log-time">'+e.hora+'</span><span class="log-dot" style="background:'+color+'"></span><span class="log-msg">'+e.label+' &rarr; '+(STATUS_NAMES[e.to]||e.to)+'</span></div>';
});
el.innerHTML=html;
}

function createIcon(p){
var st=getStatus(p);var color=STATUS_COLORS[st]||'#dc3545';
var subColor=SUBAREA_COLORS[p.sub]||'#fff';
if(p.tipo==='HUB'){
var svg='<svg width="40" height="40" viewBox="0 0 40 40">'
+'<polygon points="20,2 25,15 38,15 28,23 31,37 20,29 9,37 12,23 2,15 15,15" fill="#FFD700" stroke="#B8860B" stroke-width="1.5"/>'
+'<text x="20" y="24" text-anchor="middle" fill="#000" font-size="11" font-weight="900">H'+p.num+'</text></svg>';
return L.divIcon({html:svg,className:'',iconSize:[40,40],iconAnchor:[20,20],popupAnchor:[0,-20]});
}
// Google Maps style circular markers with Material Design icons
var sz=34,cx=17,cy=15,r=13,ir=9;
var iconPath;
if(p.tipo==='TORRE'){
iconPath='M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z';
} else if(p.tipo==='POG'){
iconPath='M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7';
} else {
iconPath='M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z';
}
var prefix=p.tipo==='TORRE'?'T':p.tipo==='POG'?'P':'';
var label=prefix+p.num;
var badgeW=label.length>2?22:16;
var borderW=p.tipo==='POG'?1.5:2.5;
var dash=p.tipo==='POG'?' stroke-dasharray="4 2"':'';
var bColor=p.tipo==='POG'?'#fff':subColor;
var svg='<svg width="'+sz+'" height="42" viewBox="0 0 '+sz+' 42">';
// Circulo com borda da subarea (A1=Gold, A2=Silver, B1=Green, B2=Blue)
svg+='<circle cx="'+cx+'" cy="'+cy+'" r="'+r+'" fill="'+color+'" stroke="'+bColor+'" stroke-width="'+borderW+'"'+dash+'/>';
// Material Design icon (nested SVG for perfect centering)
svg+='<svg x="'+(cx-ir)+'" y="'+(cy-ir)+'" width="'+(ir*2)+'" height="'+(ir*2)+'" viewBox="0 0 24 24">';
svg+='<path d="'+iconPath+'" fill="#fff"/></svg>';
// Number badge
svg+='<rect x="'+(cx-badgeW/2)+'" y="30" width="'+badgeW+'" height="11" rx="5.5" fill="rgba(0,0,0,0.85)"/>';
svg+='<text x="'+cx+'" y="38.5" text-anchor="middle" fill="#fff" font-size="7.5" font-weight="800" font-family="Arial,sans-serif">'+label+'</text>';
svg+='</svg>';
return L.divIcon({html:svg,className:'',iconSize:[sz,42],iconAnchor:[cx,cy],popupAnchor:[0,-cy]});
}

function popupContent(p){
var st=getStatus(p);var k=p.tipo+'_'+p.num;var hora=estado[k]?estado[k].hora:'';
var h='<div class="popup-title">'+p.tipo+' '+p.num+'</div>';
if(p.sub)h+='<div class="popup-sub">Subarea '+p.sub+(p.rot&&p.rot!=='A_PE'?' | Roteiro '+p.rot:p.rot==='A_PE'?' | A pe':'')+(p.hub?' | Hub: '+p.hub:'')+'</div>';
h+='<div class="popup-local">'+p.local+'</div>';
h+='<div class="popup-status"><span class="badge" style="background:'+STATUS_COLORS[st]+';color:'+(st==='EM_TRANSITO'?'#000':'#fff')+'">'+STATUS_NAMES[st]+'</span>';
if(hora)h+='<span class="popup-hora">'+hora+'</span>';
h+='</div>';
if(MODO==='editor'&&p.tipo!=='HUB'){
h+='<div class="popup-btns">';
if(st!=='PENDENTE')h+='<button class="btn btn-red btn-small" onclick="mudar(\''+p.tipo+'\',\''+p.num+'\',\'PENDENTE\')">Pendente</button>';
if(st!=='EM_TRANSITO')h+='<button class="btn btn-yellow btn-small" onclick="mudar(\''+p.tipo+'\',\''+p.num+'\',\'EM_TRANSITO\')">Transito</button>';
if(st!=='IMPLANTADO')h+='<button class="btn btn-green btn-small" onclick="mudar(\''+p.tipo+'\',\''+p.num+'\',\'IMPLANTADO\')">Implantado</button>';
if(st!=='DESMOBILIZADO')h+='<button class="btn btn-gray btn-small" onclick="mudar(\''+p.tipo+'\',\''+p.num+'\',\'DESMOBILIZADO\')">Desmob.</button>';
h+='</div>';
}
return h;
}

function mudar(tipo,num,st){var p=DADOS.find(function(d){return d.tipo===tipo&&d.num===num;});if(p){setStatus(p,st);map.closePopup();}}
function atualizarMapa(){DADOS.forEach(function(p){var k=p.tipo+'_'+p.num;if(markers[k]){markers[k].setIcon(createIcon(p));markers[k].setPopupContent(popupContent(p));}});}

function atualizarStats(){
var s={A1:{i:0,n:0},A2:{i:0,n:0},B1:{i:0,n:0},B2:{i:0,n:0},torres:{i:0,n:0},pogs:{i:0,n:0},mptr:{i:0,n:0},total:{i:0,n:0},transito:0};
DADOS.forEach(function(p){
var st=getStatus(p);var done=(st==='IMPLANTADO'||st==='DESMOBILIZADO')?1:0;
if(st==='EM_TRANSITO')s.transito++;
if(p.tipo==='APREV'){if(s[p.sub]){s[p.sub].n++;s[p.sub].i+=done;}s.total.n++;s.total.i+=done;if(p.rot==='MPTR'){s.mptr.n++;s.mptr.i+=done;}}
else if(p.tipo==='TORRE'){s.torres.n++;s.torres.i+=done;}
else if(p.tipo==='POG'){s.pogs.n++;s.pogs.i+=done;}
});
['A1','A2','B1','B2'].forEach(function(k){
var pct=s[k].n?Math.round(s[k].i/s[k].n*100):0;
document.getElementById('bar'+k).style.width=pct+'%';
document.getElementById('txt'+k).textContent=s[k].i+'/'+s[k].n+' ('+pct+'%)';
});
var totalPct=s.total.n?Math.round(s.total.i/s.total.n*100):0;
var el=document.getElementById('bigPct');el.textContent=totalPct+'%';
el.className='big-pct'+(totalPct<30?' low':totalPct<70?' mid':' high');
document.getElementById('statTorres').textContent=s.torres.i+'/'+s.torres.n;
document.getElementById('statPogs').textContent=s.pogs.i+'/'+s.pogs.n;
document.getElementById('statMptr').textContent=s.mptr.i+'/'+s.mptr.n;
['Torres','Pogs','Mptr'].forEach(function(name){var box=document.getElementById('box'+name);var key=name.toLowerCase();if(s[key]&&s[key].i===s[key].n&&s[key].n>0)box.classList.add('done');else box.classList.remove('done');});
document.getElementById('faseVal').textContent=fase;
var tl={1:'1o (17h-01h)',2:'2o (01h-05h)',3:'3o (06h-18h)'};
document.getElementById('turnoVal').textContent=tl[turno]||turno+'o';
var sitLines=[];
sitLines.push(s.total.i+'/'+s.total.n+' APREVs implantadas ('+totalPct+'%)');
if(s.transito>0)sitLines.push(s.transito+' em transito');
sitLines.push('Torres: '+s.torres.i+'/'+s.torres.n+' | POGs: '+s.pogs.i+'/'+s.pogs.n);
var critical=[];
['A1','A2','B1','B2'].forEach(function(k){var pct=s[k].n?Math.round(s[k].i/s[k].n*100):0;if(pct<50&&s[k].n>0)critical.push(k+' ('+pct+'%)');});
if(critical.length)sitLines.push('<span class="critical">Areas criticas: '+critical.join(', ')+'</span>');
else if(totalPct===100)sitLines.push('<span style="color:#28a745;font-weight:700">IMPLANTACAO COMPLETA</span>');
document.getElementById('sitrepText').innerHTML=sitLines.join('<br>');
}

function marcarRoteiro(rot,st){
var count=DADOS.filter(function(p){return p.tipo==='APREV'&&p.rot===rot;}).length;
if(!confirm('Marcar '+count+' APREVs do '+rot+' como '+STATUS_NAMES[st]+'?'))return;
var changed=0;
DADOS.forEach(function(p){if(p.tipo==='APREV'&&p.rot===rot){var old=getStatus(p);if(old!==st){setStatus(p,st,true);changed++;}}});
if(changed)addLog(rot+' ('+changed+' APREVs)','VARIOS',st,new Date().toLocaleTimeString('pt-BR'));
salvar();atualizarMapa();atualizarStats();renderLog();
}

function marcarRoteiroImpl(rot){
var count=DADOS.filter(function(p){return p.tipo==='APREV'&&p.rot===rot;}).length;
if(!confirm('Marcar '+count+' APREVs do '+rot+' como IMPLANTADO?'))return;
var changed=0;
DADOS.forEach(function(p){if(p.tipo==='APREV'&&p.rot===rot){var old=getStatus(p);if(old!=='IMPLANTADO'){setStatus(p,'IMPLANTADO',true);changed++;}}});
if(changed)addLog(rot+' ('+changed+' APREVs)','VARIOS','IMPLANTADO',new Date().toLocaleTimeString('pt-BR'));
salvar();atualizarMapa();atualizarStats();renderLog();
}

function marcarMPTR(){
if(!confirm('Marcar APREVs 21 e 46 (MPTR) como IMPLANTADO?'))return;
DADOS.forEach(function(p){if(p.rot==='MPTR')setStatus(p,'IMPLANTADO',true);});
addLog('MPTR (APREVs 21+46)','VARIOS','IMPLANTADO',new Date().toLocaleTimeString('pt-BR'));
salvar();atualizarMapa();atualizarStats();renderLog();
}

function alternarFase(){fase=(fase==='IMPLANTACAO')?'DESMOBILIZACAO':'IMPLANTACAO';addLog('Fase','','fase: '+fase,new Date().toLocaleTimeString('pt-BR'));salvar();atualizarStats();renderLog();}
function alternarTurno(){var old=turno;turno=turno>=3?1:turno+1;turnoInicio=new Date().toISOString();addLog('Turno',old+'o',turno+'o',new Date().toLocaleTimeString('pt-BR'));salvar();atualizarStats();renderLog();}

function resetTurno(){
if(!confirm('ZERAR TODOS OS STATUS? Esta acao nao pode ser desfeita!'))return;
if(!confirm('TEM CERTEZA? Todos os markers voltarao a PENDENTE.'))return;
DADOS.forEach(function(p){var k=p.tipo+'_'+p.num;estado[k]={status:'PENDENTE',hora:''};});
turnoInicio=new Date().toISOString();
addLog('RESET TURNO','','PENDENTE',new Date().toLocaleTimeString('pt-BR'));
logEntries=[logEntries[0]];
salvar();atualizarMapa();atualizarStats();renderLog();
}

function encodeStateForURL(){
var changes=[];
DADOS.forEach(function(p){var k=p.tipo+'_'+p.num;var st=estado[k]?estado[k].status:'PENDENTE';
if(st!=='PENDENTE'){var prefix=p.tipo==='APREV'?'A':p.tipo==='POG'?'P':p.tipo==='TORRE'?'T':'H';
var stCode=st==='IMPLANTADO'?'I':st==='EM_TRANSITO'?'E':st==='DESMOBILIZADO'?'D':'P';
changes.push(prefix+p.num+stCode);}});
return 'f'+(fase==='IMPLANTACAO'?'I':'D')+'t'+turno+(changes.length?'.'+changes.join(','):'');
}

function decodeStateFromHash(str){
var dotIdx=str.indexOf('.');var meta=dotIdx>=0?str.substring(0,dotIdx):str;
var entries=dotIdx>=0?str.substring(dotIdx+1).split(','):[];
fase=meta.indexOf('fI')>=0?'IMPLANTACAO':'DESMOBILIZACAO';
var tIdx=meta.indexOf('t');if(tIdx>=0)turno=parseInt(meta.charAt(tIdx+1))||1;
DADOS.forEach(function(p){var k=p.tipo+'_'+p.num;estado[k]={status:'PENDENTE',hora:''};});
entries.forEach(function(e){if(e.length<3)return;
var tipoMap={A:'APREV',P:'POG',T:'TORRE',H:'HUB'};
var stMap={I:'IMPLANTADO',E:'EM_TRANSITO',D:'DESMOBILIZADO',P:'PENDENTE'};
var tipo=tipoMap[e.charAt(0)];var stCode=e.charAt(e.length-1);var num=e.substring(1,e.length-1);
if(tipo&&stMap[stCode]){estado[tipo+'_'+num]={status:stMap[stCode],hora:''};}});
}

function compartilharLink(){
var encoded=encodeStateForURL();var baseUrl=location.origin+location.pathname;
var monitorUrl=baseUrl+'?modo=monitor#s='+encoded;
if(navigator.clipboard){navigator.clipboard.writeText(monitorUrl).then(function(){
var el=document.getElementById('shareUrl');el.textContent='Link copiado! Cole no WhatsApp para o Comando visualizar.';el.style.display='block';
setTimeout(function(){el.style.display='none';},5000);});}
if(navigator.share){navigator.share({title:'4o BPM — Carnaval 2026',text:'Painel Tatico — '+fase+' — Turno '+turno,url:monitorUrl}).catch(function(){});}
}

function exportarJSON(){
var d={status:estado,fase:fase,turno:turno,ts:new Date().toISOString()};var json=JSON.stringify(d);
if(navigator.clipboard){navigator.clipboard.writeText(json).then(function(){alert('JSON copiado!');});}
else{var ta=document.getElementById('importArea');ta.style.display='block';ta.value=json;ta.select();}
}

function toggleImport(){var ta=document.getElementById('importArea');var btn=document.getElementById('btnAplicar');var show=ta.style.display!=='block';ta.style.display=show?'block':'none';btn.style.display=show?'block':'none';}

function importarEstado(){
var ta=document.getElementById('importArea');var val=ta.value.trim();
if(val.indexOf('#s=')>=0){var hash=val.substring(val.indexOf('#s=')+3);decodeStateFromHash(hash);salvar();atualizarMapa();atualizarStats();alert('Estado importado do link!');ta.style.display='none';document.getElementById('btnAplicar').style.display='none';return;}
try{var d=JSON.parse(val);if(d.status){estado=d.status;fase=d.fase||fase;turno=d.turno||turno;}salvar();atualizarMapa();atualizarStats();alert('Estado importado!');ta.style.display='none';document.getElementById('btnAplicar').style.display='none';}
catch(e){alert('Formato invalido! Use JSON ou link compartilhado.');}
}

function atualizarTimer(){if(!turnoInicio)return;var diff=Date.now()-new Date(turnoInicio).getTime();var h=Math.floor(diff/3600000);var m=Math.floor((diff%3600000)/60000);document.getElementById('timerVal').textContent=h+'h'+(m<10?'0':'')+m+'m';}

// =============================================
// GOOGLE SHEETS INTEGRATION
// =============================================
// Configure: cole o ID da planilha Google aqui
var SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQdIrzrfS6AswuNJgKaYSAN5pF9mJhBehJexO5MDR8j-zWQjyM3aDI5_xyz3kPnDaJ3cCNdgMb2Nt0e/pub?gid=0&single=true&output=csv';
// Override via URL params: ?sheet=SHEET_ID or ?csv=FULL_URL
(function(){
var p=new URLSearchParams(location.search);
if(p.get('csv'))SHEET_CSV_URL=p.get('csv');
else if(p.get('sheet'))SHEET_CSV_URL='https://docs.google.com/spreadsheets/d/'+p.get('sheet')+'/gviz/tq?tqx=out:csv&sheet=Status';
})();
var APPS_SCRIPT_URL = '';
// Auto-detect from URL: ?api=YOUR_APPS_SCRIPT_URL
(function(){var p=new URLSearchParams(location.search);if(p.get('api'))APPS_SCRIPT_URL=p.get('api');})();
var REFRESH_INTERVAL = 10000; // 10 segundos

function getSheetURL(){
return SHEET_CSV_URL;
}

function parseCSVLine(line){
var result=[];var current='';var inQuotes=false;
for(var i=0;i<line.length;i++){
var c=line.charAt(i);
if(c==='"'){inQuotes=!inQuotes;}
else if(c===','&&!inQuotes){result.push(current.trim());current='';}
else{current+=c;}
}
result.push(current.trim());
return result;
}

function fetchFromSheet(){
var url=getSheetURL();
if(!url)return;
fetch(url,{cache:'no-store'})
.then(function(r){return r.text();})
.then(function(csv){
var lines=csv.split('\n');
if(lines.length<2)return;
var headers=parseCSVLine(lines[0]);
var tipoIdx=headers.indexOf('Tipo');
var numIdx=headers.indexOf('Num');
var statusIdx=headers.indexOf('Status');
var horaIdx=headers.indexOf('Hora');
if(tipoIdx<0||numIdx<0||statusIdx<0)return;
for(var i=1;i<lines.length;i++){
if(!lines[i].trim())continue;
var cols=parseCSVLine(lines[i]);
var tipo=cols[tipoIdx]||'';
var num=cols[numIdx]||'';
if(num.length===1)num='0'+num;
var st=cols[statusIdx]||'PENDENTE';
var hora=cols[horaIdx]||'';
var k=tipo+'_'+num;
if(estado[k]){
estado[k]={status:st.replace(/ /g,'_').toUpperCase(),hora:hora};
}
}
atualizarMapa();atualizarStats();renderLog();
if(MODO==='editor')renderChips();
document.getElementById('lastUpdate').textContent=new Date().toLocaleTimeString('pt-BR');
})
.catch(function(e){console.log('Sheet fetch error:',e);});
}


function init(){
initEstado();
if(MODO!=='editor'){
document.getElementById('monitor-banner').classList.add('active');
document.getElementById('controlsDiv').style.display='none';
document.getElementById('shareDiv').style.display='none';
setInterval(function(){
if(location.hash&&location.hash.indexOf('#s=')===0){decodeStateFromHash(location.hash.substring(3));}
else{var saved=localStorage.getItem(STORAGE_KEY);if(saved){try{var d=JSON.parse(saved);estado=d.status||estado;fase=d.fase||fase;turno=d.turno||turno;logEntries=d.log||logEntries;}catch(e){}}}
atualizarMapa();atualizarStats();renderLog();
},5000);
}
map=L.map('map',{zoomControl:true,attributionControl:false}).setView([-22.9100,-43.1990],15);
L.control.attribution({position:'bottomright',prefix:false}).addTo(map);
var savedTile=localStorage.getItem('dash-tile')||'dark';
setTile(savedTile);
DADOS.forEach(function(p){
var k=p.tipo+'_'+p.num;
var zOff=p.tipo==='HUB'?1000:p.tipo==='TORRE'?800:p.tipo==='APREV'?500:300;
var m=L.marker([p.lat,p.lon],{icon:createIcon(p),zIndexOffset:zOff});
m.bindPopup(popupContent(p),{maxWidth:300,closeButton:true});
m.addTo(map);markers[k]=m;
});
atualizarStats();renderLog();
if(MODO==='editor')renderChips();
document.getElementById('lastUpdate').textContent=new Date().toLocaleTimeString('pt-BR');
if(!turnoInicio)turnoInicio=new Date().toISOString();
// Google Sheets auto-refresh
if(SHEET_CSV_URL&&(MODO!=='editor'||APPS_SCRIPT_URL)){
fetchFromSheet();
setInterval(fetchFromSheet,REFRESH_INTERVAL);
document.getElementById('sheetStatus').textContent='Planilha conectada';
document.getElementById('sheetStatus').style.color='#28a745';
}
atualizarTimer();setInterval(atualizarTimer,60000);
}


// =============================================
// CHIPS + SYNC + SAIDA DE ROTA
// =============================================
function syncToSheet(tipo,num,status){
if(!APPS_SCRIPT_URL)return;
var url=APPS_SCRIPT_URL+'?tipo='+encodeURIComponent(tipo)+'&num='+encodeURIComponent(num)+'&status='+encodeURIComponent(status);
fetch(url,{redirect:'follow',mode:'no-cors'}).catch(function(e){console.log('Sync:',e);});
}

function syncBatchToSheet(updates){
if(!APPS_SCRIPT_URL||!updates.length)return;
var batch=updates.map(function(u){return u.tipo+'_'+u.num+'_'+u.status;}).join(',');
fetch(APPS_SCRIPT_URL+'?batch='+encodeURIComponent(batch),{redirect:'follow',mode:'no-cors'}).catch(function(e){console.log('Batch sync:',e);});
}

function updateChip(tipo,num){
var el=document.getElementById('c_'+tipo+'_'+num);
if(!el)return;
var p=DADOS.find(function(d){return d.tipo===tipo&&d.num===num;});
if(!p)return;
var st=getStatus(p);
var cls='chip chip-'+(st==='IMPLANTADO'?'I':st==='EM_TRANSITO'?'E':st==='DESMOBILIZADO'?'D':'P');
el.className=cls+' chip-flash';
setTimeout(function(){el.className=cls;},400);
updateRouteCount(p);
}

function updateRouteCount(p){
if(p.tipo==='HUB')return;
var rot=p.tipo==='APREV'?p.rot:(p.tipo==='POG'?'POG':'TORRE');
var arr=DADOS.filter(function(d){
if(p.tipo==='APREV')return d.tipo==='APREV'&&d.rot===rot;
if(p.tipo==='POG')return d.tipo==='POG';
return d.tipo==='TORRE';
});
var impl=arr.filter(function(d){var s=getStatus(d);return s==='IMPLANTADO'||s==='DESMOBILIZADO';}).length;
var el=document.getElementById('rc_'+rot);
if(el)el.textContent=impl+'/'+arr.length;
}

function renderChips(){
var container=document.getElementById('chipContainer');
if(!container)return;
var routes={R1:[],R2:[],R3:[],A_PE:[],MPTR:[]};
var pogs=[],torres=[];
DADOS.forEach(function(p){
if(p.tipo==='HUB')return;
if(p.tipo==='TORRE'){torres.push(p);return;}
if(p.tipo==='POG'){pogs.push(p);return;}
var rot=p.rot||'A_PE';
if(!routes[rot])routes[rot]=[];
routes[rot].push(p);
});
var html='';
var routeLabels={R1:'Rota 1 — 4BPM',R2:'Rota 2 — 4BPM',R3:'Rota 3 — 4BPM',A_PE:'A Pe — BPChq',MPTR:'MPTR — Tuneis'};
['R1','R2','R3','A_PE','MPTR'].forEach(function(rot){
var arr=routes[rot];if(!arr||!arr.length)return;
var impl=arr.filter(function(d){var s=getStatus(d);return s==='IMPLANTADO'||s==='DESMOBILIZADO';}).length;
html+='<div class="chip-route"><div class="chip-route-header"><span class="chip-route-title">'+(routeLabels[rot]||rot)+'</span>';
html+='<span class="chip-route-count" id="rc_'+rot+'">'+impl+'/'+arr.length+'</span></div>';
html+='<div class="chip-grid">';
arr.forEach(function(p){
var st=getStatus(p);
var cls=st==='IMPLANTADO'?'chip-I':st==='EM_TRANSITO'?'chip-E':st==='DESMOBILIZADO'?'chip-D':'chip-P';
html+='<span class="chip '+cls+'" id="c_'+p.tipo+'_'+p.num+'" onclick="chipTap(\''+p.tipo+'\',\''+p.num+'\')">'+p.num+'</span>';
});
html+='</div></div>';
});
if(pogs.length){
var implP=pogs.filter(function(d){var s=getStatus(d);return s==='IMPLANTADO'||s==='DESMOBILIZADO';}).length;
html+='<div class="chip-route"><div class="chip-route-header"><span class="chip-route-title">POGs</span>';
html+='<span class="chip-route-count" id="rc_POG">'+implP+'/'+pogs.length+'</span></div>';
html+='<div class="chip-grid">';
pogs.forEach(function(p){
var st=getStatus(p);
var cls=st==='IMPLANTADO'?'chip-I':st==='EM_TRANSITO'?'chip-E':st==='DESMOBILIZADO'?'chip-D':'chip-P';
html+='<span class="chip '+cls+'" id="c_'+p.tipo+'_'+p.num+'" onclick="chipTap(\''+p.tipo+'\',\''+p.num+'\')">P'+p.num+'</span>';
});
html+='</div></div>';
}
if(torres.length){
var implT=torres.filter(function(d){var s=getStatus(d);return s==='IMPLANTADO'||s==='DESMOBILIZADO';}).length;
html+='<div class="chip-route"><div class="chip-route-header"><span class="chip-route-title">Torres</span>';
html+='<span class="chip-route-count" id="rc_TORRE">'+implT+'/'+torres.length+'</span></div>';
html+='<div class="chip-grid">';
torres.forEach(function(p){
var st=getStatus(p);
var cls=st==='IMPLANTADO'?'chip-I':st==='EM_TRANSITO'?'chip-E':st==='DESMOBILIZADO'?'chip-D':'chip-P';
html+='<span class="chip '+cls+'" id="c_'+p.tipo+'_'+p.num+'" onclick="chipTap(\''+p.tipo+'\',\''+p.num+'\')">T'+p.num+'</span>';
});
html+='</div></div>';
}
container.innerHTML=html;
}

function chipTap(tipo,num){
var p=DADOS.find(function(d){return d.tipo===tipo&&d.num===num;});
if(!p)return;
var st=getStatus(p);
var newSt;
if(fase==='DESMOBILIZACAO'){
newSt=(st==='DESMOBILIZADO')?'IMPLANTADO':'DESMOBILIZADO';
} else {
if(st==='PENDENTE'||st==='EM_TRANSITO')newSt='IMPLANTADO';
else return;
}
setStatus(p,newSt);
}

function saidaRota(rot){
var arr=DADOS.filter(function(p){return p.rot===rot&&(p.tipo==='APREV');});
var pendentes=arr.filter(function(p){return getStatus(p)==='PENDENTE';});
if(!pendentes.length){
var btn=document.getElementById('btn_'+rot);
if(btn){btn.classList.add('saiu');btn.textContent=rot.replace('_',' ')+' - ja saiu';}
return;
}
if(!confirm(pendentes.length+' APREVs da '+rot+' saindo. Marcar EM TRANSITO?'))return;
var updates=[];
pendentes.forEach(function(p){setStatus(p,'EM_TRANSITO',true);updates.push({tipo:p.tipo,num:p.num,status:'EM_TRANSITO'});});
addLog(rot+' ('+pendentes.length+' APREVs)','PENDENTE','EM_TRANSITO',new Date().toLocaleTimeString('pt-BR'));
salvar();atualizarMapa();atualizarStats();renderLog();renderChips();
syncBatchToSheet(updates);
var btn=document.getElementById('btn_'+rot);
if(btn){btn.classList.add('saiu');btn.textContent=rot.replace('_',' ')+' saiu';}
}


document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>